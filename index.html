<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Product Picks</title>
<meta name="description" content="Independent product picks. As an Amazon Associate, we earn from qualifying purchases.">
<style>
  :root{
    --bg:#f4f4f9;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --primary:#111827;
    --soft:#f9fafb;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }

  header{
    background:linear-gradient(135deg,#0f172a,#020617);
    color:#fff; text-align:center;
    padding:22px 12px 14px;
  }
  header h1{ margin:0 0 8px 0; font-size:2em; font-weight:800; letter-spacing:.2px; }
  .topbar{
    display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
    padding:0 12px 6px;
  }
  .country-select, .search-input{
    font-size:14px; padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; outline:none;
  }
  .search-input{ min-width:min(420px, 90vw); }
  .wrap{ max-width:1200px; margin:14px auto 26px; padding:0 12px; }

  /* ===== Homepage Hero (risk-control friendly) ===== */
  .hero{
    margin-top:12px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 14px;
    line-height:1.6;
  }
  .hero .title{
    font-size:14px;
    font-weight:900;
    color:#111827;
    margin:0 0 6px 0;
  }
  .hero .desc{
    font-size:12px;
    color:#374151;
    margin:0;
  }
  .hero .desc strong{ font-weight:900; }
  .hero .hint{
    margin-top:8px;
    font-size:12px;
    color:#4b5563;
  }
  .hero .hint a{ color:#2563eb; text-decoration:none; }

  .compliance{
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 14px;
    line-height:1.55;
    margin-top:12px;
  }
  .compliance .row{
    display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:flex-start;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--soft);
    font-size:12px; color:#374151;
    white-space:nowrap;
  }
  .compliance strong{ font-weight:800; }
  .compliance .small{ font-size:12px; color:#4b5563; margin-top:8px; }
  .compliance a{ color:#2563eb; text-decoration:none; }

  .status-bar{
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
    margin-top:12px;
    background:#fff; border:1px solid var(--border); border-radius:14px;
    padding:10px 12px;
  }
  .badge{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:var(--soft); }
  .muted{ color:var(--muted); font-size:12px; }
  .btn{
    cursor:pointer; border-radius:12px; border:1px solid var(--border);
    padding:9px 12px; font-weight:800; font-size:13px;
    background:var(--primary); color:#fff;
  }
  .btn:hover{ opacity:.92; }
  .btn.secondary{ background:#fff; color:#111827; }

  .howto{
    margin-top:12px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 14px;
  }
  .howto h2{ margin:0 0 8px 0; font-size:16px; }
  .howto .cols{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
  }
  @media(max-width:780px){ .howto .cols{ grid-template-columns:1fr; } }
  .howto .item{
    background:var(--soft);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 10px;
  }
  .howto .item h3{ margin:0 0 6px 0; font-size:13px; }
  .howto .item p{ margin:0; font-size:12px; color:#374151; line-height:1.55; }
  .howto .note{
    margin-top:10px;
    font-size:12px;
    color:#4b5563;
    line-height:1.6;
  }

  .grid{
    margin-top:14px;
    display:grid;
    grid-template-columns:repeat(3, minmax(0, 1fr));
    gap:14px;
  }
  @media (max-width: 980px){ .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 640px){ .grid{ grid-template-columns:repeat(1, minmax(0, 1fr)); } }

  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.04);
  }
  .image-wrap{
    display:flex; flex-direction:column; align-items:center; gap:10px;
  }
  .product-image{
    width:100%;
    max-width:360px;
    aspect-ratio:1/1;
    object-fit:contain;
    border-radius:16px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    transition: transform .12s ease;
    display:block;
  }
  .product-image:hover{ transform:scale(1.02); }

  /* 不展示 ASIN 行，但复制仍包含 ASIN */
  .asin{ display:none !important; }

  /* advisor 更短 */
  .why{
    width:100%;
    max-width:360px;
    margin-top:4px;
    padding:8px 10px;
    background:#f9fafb;
    border:1px solid #e5e7eb;
    border-radius:12px;
    font-size:12px;
    color:#374151;
    line-height:1.55;
  }
  .why strong{ font-weight:800; }
  .why .subtle{ color:#4b5563; }

  .actions{
    width:100%;
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:2px;
  }
  .cta{
    width:min(260px, 100%);
    text-align:center;
    text-decoration:none;
    display:inline-flex;
    justify-content:center;
    align-items:center;
  }

  .empty{
    margin-top:14px;
    padding:14px;
    border:1px solid var(--border);
    border-radius:14px;
    background:#fff;
    color:var(--muted);
    text-align:center;
    font-size:14px;
  }

  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); padding-top:60px; z-index:999; }
  .modal-inner{
    width:90%; max-width:560px; margin:0 auto;
    background:#fff; border-radius:16px; padding:14px; position:relative;
    box-shadow:0 10px 30px rgba(0,0,0,.18);
  }
  .close{
    position:absolute; right:14px; top:10px; font-size:26px; font-weight:900; cursor:pointer; user-select:none;
  }
  .contact-btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 14px; border-radius:12px;
    background:#fff; color:#111827; text-decoration:none; border:1px solid var(--border);
    font-weight:900; font-size:14px;
  }
  .contact-btn:hover{ background:#f9fafb; }
  .mini-hint{ margin-top:10px;font-size:12px;color:#6b7280;line-height:1.55; }

  footer{
    margin-top:18px;
    background:#fff; border-top:1px solid var(--border);
    padding:16px 12px;
  }
  footer .inner{ max-width:1200px; margin:0 auto; font-size:12px; color:#374151; line-height:1.7; }
  footer a{ color:#2563eb; text-decoration:none; }
</style>
</head>
<body>

<header>
  <h1>Product Picks</h1>
  <div class="topbar">
    <select class="country-select" id="countrySelect" onchange="onMarketChange()">
      <option value="US">US</option>
      <option value="UK">UK</option>
      <option value="DE">DE</option>
      <option value="FR">FR</option>
      <option value="IT">IT</option>
      <option value="ES">ES</option>
      <option value="CA">CA</option>
      <option value="JP">JP</option>
    </select>
    <input class="search-input" id="searchInput" placeholder="Search by ASIN / title…" oninput="renderGrid()"/>
  </div>
</header>

<div class="wrap">

  <!-- ✅ Homepage Hero (inserted) -->
  <section class="hero" aria-label="Independent product reference">
    <div class="title">Independent product reference</div>
    <p class="desc">
      This website lists product identifiers and references to items available on Amazon.
      <strong>All purchases are completed on Amazon</strong> via the product pages.
      We do not sell products directly and do not process orders or payments.
    </p>
    <div class="hint">
      Need help identifying an item? Use <strong>Contact / Copy</strong> to copy Title / ASIN / Market and reach us for general assistance.
      See <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a> and <a href="./terms.html" target="_blank" rel="noopener">Terms</a>.
    </div>
  </section>

  <div class="compliance">
    <div class="row">
      <div class="pill"><strong>Disclosure</strong>: As an Amazon Associate, we earn from qualifying purchases.</div>
      <div class="pill">Independent site · Not endorsed by Amazon</div>
    </div>
    <div class="small">
      Amazon and the Amazon logo are trademarks of Amazon.com, Inc. or its affiliates. We provide independent product references and redirect you to Amazon for purchase.
      See <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a> and <a href="./terms.html" target="_blank" rel="noopener">Terms</a>.
    </div>
  </div>

  <div class="status-bar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <span class="badge" id="statusBadge">Loading…</span>
      <span class="muted" id="statusMeta"></span>
    </div>
    <button class="btn" onclick="fetchProductData(true)">Refresh</button>
  </div>

  <div class="howto">
    <h2>How to choose</h2>
    <div class="cols">
      <div class="item">
        <h3>1) Confirm compatibility</h3>
        <p>Before buying, confirm model/size/region compatibility on the Amazon product page, especially for electronics, consumables, and replacement parts.</p>
      </div>
      <div class="item">
        <h3>2) Check seller & fulfillment</h3>
        <p>Prefer reputable sellers and reliable fulfillment methods. Review shipping speed, return policy, and warranty terms on Amazon.</p>
      </div>
      <div class="item">
        <h3>3) Compare variants</h3>
        <p>Many products have variants (color, bundle, capacity). Make sure you select the correct variant on Amazon before checkout.</p>
      </div>
      <div class="item">
        <h3>4) Read recent reviews</h3>
        <p>Focus on recent verified purchase reviews. Pay attention to recurring issues rather than single outliers.</p>
      </div>
    </div>
    <div class="note">
      Note: We do not guarantee pricing or availability. Final product details, pricing, and purchase terms are provided by Amazon on the destination page.
    </div>
  </div>

  <div class="grid" id="productGrid"></div>

  <div class="empty" id="emptyHint" style="display:none;">
    No products loaded. Ensure <code>products.json</code> is available in this folder and contains items for the selected market.
  </div>

</div>

<div class="modal" id="contactModal" onclick="closeContactModal(event)">
  <div class="modal-inner" onclick="event.stopPropagation()">
    <span class="close" onclick="closeContactModal(event)">×</span>

    <h3 style="margin:0 0 10px 0;">Contact & Copy</h3>
    <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">
      Copy only Title / ASIN / Market. Contact buttons are for consultation and do not include Amazon links.
    </div>

    <div id="contactPreview"
         style="border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#f9fafb;white-space:pre-wrap;font-size:13px;line-height:1.45;text-align:left;"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;">
      <button class="btn" onclick="copyContactInfo()" style="background:#374151;">Copy info</button>
      <a class="contact-btn" href="#" id="contactWA" rel="noopener noreferrer" target="_blank">WhatsApp</a>
      <a class="contact-btn" href="#" id="contactTG" rel="noopener noreferrer" target="_blank">Telegram</a>
      <a class="contact-btn" href="#" id="contactMail" rel="noopener noreferrer" target="_blank">Email</a>
      <button class="btn secondary" onclick="closeContactModal(event)">Close</button>
    </div>

    <div class="mini-hint">
      For purchase, use the “View on Amazon” button on the product card. Final pricing and availability are provided by Amazon on the destination page.
    </div>
  </div>
</div>

<footer>
  <div class="inner">
    <div><strong>Affiliate disclosure:</strong> As an Amazon Associate, we earn from qualifying purchases.</div>
    <div><strong>Independence:</strong> This site is not an official Amazon website and is not endorsed by Amazon.</div>
    <div><strong>Links:</strong> “View on Amazon” redirects to Amazon. Amazon may use cookies for tracking qualifying purchases.</div>
    <div style="margin-top:6px;">
      <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a> ·
      <a href="./terms.html" target="_blank" rel="noopener">Terms</a>
    </div>
    <div style="margin-top:6px;">© 2025 ama.omino.top</div>
  </div>
</footer>

<script>
  const PRODUCTS_JSON_PATH = "./products.json";

  const WA_PHONE = "8615778673666";
  const TG_USERNAME = "dalemyrong";
  const EMAIL_CONTACT = "info@dalemy.top";

  const AUTO_REFRESH_MS = 60 * 1000;

  let ALL_PRODUCTS = [];
  let LAST_LOADED_AT = null;
  let CURRENT_CONTACT_PRODUCT = null;

  /* ========= Placeholder (only used after multiple retries) ========= */
  const PLACEHOLDER_SVG = `
    <svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" viewBox="0 0 800 800">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#f3f4f6"/>
          <stop offset="1" stop-color="#e5e7eb"/>
        </linearGradient>
      </defs>
      <rect width="800" height="800" rx="48" fill="url(#g)"/>
      <rect x="180" y="220" width="440" height="300" rx="26" fill="#ffffff" stroke="#d1d5db" stroke-width="6"/>
      <circle cx="280" cy="310" r="34" fill="#e5e7eb"/>
      <path d="M210 490 L340 360 L430 450 L510 390 L590 490" fill="none" stroke="#d1d5db" stroke-width="14" stroke-linecap="round" stroke-linejoin="round"/>
      <text x="400" y="590" text-anchor="middle" font-family="Arial, sans-serif" font-size="34" fill="#6b7280">Image unavailable</text>
      <text x="400" y="640" text-anchor="middle" font-family="Arial, sans-serif" font-size="22" fill="#9ca3af">Placeholder</text>
    </svg>
  `;
  const PLACEHOLDER_DATA_URI = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(PLACEHOLDER_SVG);

  function currentMarket(){
    return (document.getElementById("countrySelect").value || "US").toUpperCase();
  }
  function normalizeUrl(u){
    const s = String(u || "").trim();
    if (!s) return "";
    if (/^https?:\/\//i.test(s)) return s;
    return "";
  }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
  function setStatus(text, meta=""){
    document.getElementById("statusBadge").textContent = text;
    document.getElementById("statusMeta").textContent = meta;
  }
  function showEmpty(show){
    document.getElementById("emptyHint").style.display = show ? "block" : "none";
  }

  /* ========= Image URL resolver (maximize display rate) ========= */
  function isHttpsPage(){
    return String(location.protocol || "").toLowerCase() === "https:";
  }
  function upgradeToHttps(url){
    return String(url || "").replace(/^http:\/\//i, "https://");
  }
  function toWeserv(url){
    const cleaned = String(url || "").replace(/^https?:\/\//i, "");
    return "https://images.weserv.nl/?url=" + encodeURIComponent(cleaned);
  }
  function initialImageUrl(raw){
    const u = normalizeUrl(raw);
    if (!u) return PLACEHOLDER_DATA_URI;
    return u;
  }

  function onImgError(imgEl){
    try{
      if (!imgEl) return;
      const stage = Number(imgEl.dataset.stage || "0"); // 0 original, 1 https-upgrade, 2 proxy, 3 placeholder
      const original = String(imgEl.dataset.original || "");
      if (!original) {
        imgEl.src = PLACEHOLDER_DATA_URI;
        return;
      }

      if (stage === 0){
        imgEl.dataset.stage = "1";
        if (isHttpsPage() && /^http:\/\//i.test(original)){
          imgEl.src = upgradeToHttps(original);
          return;
        }
        imgEl.src = toWeserv(original);
        imgEl.dataset.stage = "2";
        return;
      }

      if (stage === 1){
        imgEl.dataset.stage = "2";
        imgEl.src = toWeserv(original);
        return;
      }

      imgEl.dataset.stage = "3";
      imgEl.src = PLACEHOLDER_DATA_URI;
      imgEl.removeAttribute("srcset");
    }catch(e){
      try{ imgEl.src = PLACEHOLDER_DATA_URI; }catch(_){}
    }
  }

  function fetchProductData(manual=false){
    const url = PRODUCTS_JSON_PATH + "?ts=" + Date.now();
    setStatus(manual ? "Refreshing…" : "Loading…", "Fetching products.json");

    fetch(url, { cache:"no-store" })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        return res.json();
      })
      .then(list => {
        if (!Array.isArray(list)) throw new Error("products.json is not an array");
        ALL_PRODUCTS = list.map((p, idx) => ({...p, __idx: idx}));
        LAST_LOADED_AT = new Date();
        renderGrid();
        setStatus("Loaded", `${ALL_PRODUCTS.length} items · ${LAST_LOADED_AT.toLocaleString()}`);
        showEmpty(ALL_PRODUCTS.length === 0);
      })
      .catch(err => {
        console.error(err);
        setStatus("Load failed", err.message);
        showEmpty(true);
        if (manual) alert("Failed to load products.json.\n\n" + err.message);
      });
  }

  function getVisibleProducts(){
    const m = currentMarket();
    const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();

    return ALL_PRODUCTS
      .filter(p => String(p.market || "").trim().toUpperCase() === m)
      .filter(p => {
        if (!q) return true;
        const hay = [p.asin, p.title].map(v => String(v || "").toLowerCase()).join(" ");
        return hay.includes(q);
      })
      .sort((a,b) => (a.__idx ?? 0) - (b.__idx ?? 0));
  }

  function encodeProductForOnclick(p){
    const safe = {
      market: p.market || "",
      asin: p.asin || "",
      title: p.title || "",
      link: p.link || "",
      image_url: p.image_url || "",
      __idx: p.__idx ?? 0
    };
    return JSON.stringify(safe)
      .replaceAll("&","\\u0026").replaceAll("<","\\u003c").replaceAll(">","\\u003e");
  }

  function openProductLink(product){
    const url = normalizeUrl(product && product.link);
    if (!url){ alert("This item has no valid Amazon link."); return; }
    window.open(url, "_blank", "noopener,noreferrer");
  }

  /* ========= advisor (short) copy generator ========= */
  function hash32(str){
    const s = String(str || "");
    let h = 2166136261;
    for (let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }
  function seededPick(arr, seed, salt){
    if (!arr || arr.length === 0) return "";
    const h = hash32(seed + "|" + salt);
    return arr[h % arr.length];
  }

  function classifyProduct(p){
    const t = String(p?.title || "").toLowerCase();
    const has = (...kw) => kw.some(k => t.includes(k));

    if (has("birthday","anniversary","gift","present","decor","lamp","night light","plaque","acrylic","frame","sign","ornament")) return "gift_decor";
    if (has("tooth","teeth","whitening","mouth","oral","dental","brush","flosser","water flosser")) return "oral_care";
    if (has("boot","boots","shoe","shoes","sneaker","rain boot","rain boots")) return "footwear";
    if (has("mouse","mice","rat","rodent","pest","repellent","trap","cat","dog","pet")) return "pet_pest";
    if (has("hook","hanger","adhesive","mount","bracket","screw","bolt","drill","tool","hardware")) return "hardware";
    if (has("charger","adapter","usb","hdmi","cable","battery","router","camera","monitor","keyboard","mouse","earbuds","headphone","speaker")) return "electronics";
    if (has("cream","serum","lotion","shampoo","soap","skincare","cosmetic","deodorant","razor")) return "personal_care";
    if (has("hoodie","shirt","t-shirt","jacket","sweater","dress","cap","hat","pants","sock")) return "apparel";
    if (has("kitchen","pan","pot","knife","cook","coffee","mug","bottle","cup","spoon","fork")) return "kitchen";
    if (has("replacement","refill","filter","cartridge","spare")) return "replacement";
    if (has("printer","filament","pla","abs","3d")) return "3d_printing";

    return "general";
  }

  function buildWhyPickedShortAdvisor(p){
    const title = String(p?.title || "").trim();
    const asin = String(p?.asin || "").trim();
    const market = String(p?.market || "").trim().toUpperCase();
    const seed = (market || "US") + "|" + (asin || title || "x");
    const bucket = classifyProduct(p);

    const HEADS = ["Why we picked it", "Advisor note", "Quick guidance", "Selection note"];
    const OPENERS = [
      "Picked for a practical fit rather than hype.",
      "Selected as a sensible baseline option.",
      "Chosen for straightforward use and clear selection steps.",
      "Included for common scenarios where details matter."
    ];

    const CHECKS_BY_BUCKET = {
      electronics: [
        "Check: ports/specs match your device (power, size, standards).",
        "Check: compatibility notes and required cables/adapters.",
        "Check: voltage/power requirements and included accessories."
      ],
      footwear: [
        "Check: size chart and fit notes; returns matter for sizing.",
        "Check: material and intended weather/use conditions.",
        "Check: measurements and care instructions before checkout."
      ],
      gift_decor: [
        "Check: dimensions, display method, and personalization details.",
        "Check: what’s included for setup (stand/hardware/parts).",
        "Check: wording/custom options and return policy for customized items."
      ],
      oral_care: [
        "Check: directions, cautions, and included accessories.",
        "Check: replacement parts availability and cleaning guidance.",
        "Check: usage fit for your routine and any sensitivity notes."
      ],
      pet_pest: [
        "Check: placement guidance and safety notes for pets/children.",
        "Check: coverage area and power/operating mode details.",
        "Check: realistic expectations and correct use instructions."
      ],
      hardware: [
        "Check: dimensions, surface compatibility, and load guidance.",
        "Check: install method (adhesive/screws) and required tools.",
        "Check: spacing/clearance and what’s included."
      ],
      kitchen: [
        "Check: dimensions/capacity and material care instructions.",
        "Check: compatibility with your cookware/appliance setup.",
        "Check: what’s included and cleaning guidance."
      ],
      replacement: [
        "Check: exact model/fit compatibility and pack quantity.",
        "Check: specs/dimensions and replacement interval if listed.",
        "Check: variant selection at checkout (model/version)."
      ],
      personal_care: [
        "Check: label directions, cautions, and intended use.",
        "Check: ingredients/notes and personal restrictions.",
        "Check: quantity/size and storage guidance."
      ],
      apparel: [
        "Check: sizing details, fabric, and care instructions.",
        "Check: variant selection (size/color) and return policy.",
        "Check: measurements and fit notes before checkout."
      ],
      general: [
        "Check: size/variant selection and what’s included.",
        "Check: seller/fulfillment and return policy details on Amazon.",
        "Check: key specs and the exact variant at checkout."
      ],
      "3d_printing": [
        "Check: filament type/diameter and spool compatibility.",
        "Check: recommended temps and storage notes if provided.",
        "Check: printer compatibility and material properties."
      ]
    };

    const FINAL_REMINDERS = [
      "Tip: verify the exact variant on Amazon before checkout.",
      "Tip: confirm seller/fulfillment and return terms on Amazon.",
      "Tip: double-check what’s included and the selected option at checkout."
    ];

    const head = seededPick(HEADS, seed, "h");
    const opener = seededPick(OPENERS, seed, "o");
    const checks = CHECKS_BY_BUCKET[bucket] || CHECKS_BY_BUCKET.general;
    const line1 = seededPick(checks, seed, "c1");
    const line2 = seededPick(FINAL_REMINDERS, seed, "r");

    return { head, opener, line1, line2 };
  }

  function whyHtml(p){
    const w = buildWhyPickedShortAdvisor(p);
    return `
      <div class="why">
        <strong>${escapeHtml(w.head)}</strong><br>
        <span class="subtle">${escapeHtml(w.opener)}</span><br>
        • <span class="subtle">${escapeHtml(w.line1)}</span><br>
        • <span class="subtle">${escapeHtml(w.line2)}</span>
      </div>
    `;
  }

  function renderGrid(){
    const grid = document.getElementById("productGrid");
    const items = getVisibleProducts();
    grid.innerHTML = "";

    items.forEach(p => {
      const asin = String(p.asin || "").trim();
      const imgRaw  = String(p.image_url || "").trim();
      const link = normalizeUrl(p.link);

      const card = document.createElement("div");
      card.className = "card";

      const viewAmazon = link
        ? `<a class="btn cta" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer nofollow sponsored">View on Amazon</a>`
        : `<button class="btn cta" onclick="alert('No valid Amazon link for this item.');">View on Amazon</button>`;

      const imgSrc = initialImageUrl(imgRaw);

      card.innerHTML = `
        <div class="image-wrap">
          <img class="product-image"
               src="${escapeHtml(imgSrc)}"
               data-original="${escapeHtml(normalizeUrl(imgRaw) || "")}"
               data-stage="0"
               alt="${escapeHtml(asin || 'Product')}"
               loading="lazy"
               decoding="async"
               referrerpolicy="no-referrer"
               onerror="onImgError(this)"
               onclick='openProductLink(${encodeProductForOnclick(p)})' />

          <div class="asin" title="${escapeHtml(asin)}">ASIN: ${escapeHtml(asin || "-")}</div>

          ${whyHtml(p)}

          <div class="actions">
            ${viewAmazon}
            <button class="btn cta secondary" onclick='openContactModal(${encodeProductForOnclick(p)})'>Contact / Copy</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });

    showEmpty(items.length === 0);
    if (LAST_LOADED_AT){
      setStatus("Loaded", `${items.length}/${ALL_PRODUCTS.length} visible · ${LAST_LOADED_AT.toLocaleString()}`);
    }
  }

  function onMarketChange(){
    localStorage.setItem("selectedCountry", currentMarket());
    renderGrid();
  }

  function copyText(text){
    if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
    return new Promise((resolve, reject) => {
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        resolve();
      }catch(e){ reject(e); }
    });
  }

  // 复制：只要 Title/ASIN/Market（不含任何链接）
  function buildCopyInfo(product){
    const market = String(product.market || "").trim().toUpperCase();
    const asin = String(product.asin || "").trim();
    const title = String(product.title || "").trim();

    const lines = [];
    if (title) lines.push(title);
    if (asin) lines.push(`ASIN: ${asin}`);
    if (market) lines.push(`Market: ${market}`);
    return lines.join("\n");
  }

  function buildContactText(product){
    const base = buildCopyInfo(product);
    const lines = [];
    if (base) lines.push(base);
    lines.push("");
    lines.push("Hi, I have a question about this product. Could you please help?");
    return lines.join("\n");
  }

  function openContactModal(product){
    CURRENT_CONTACT_PRODUCT = product;

    const previewText = buildCopyInfo(product);
    document.getElementById("contactPreview").textContent = previewText;

    const contactText = buildContactText(product);

    const waUrl = "https://wa.me/" + WA_PHONE + "?text=" + encodeURIComponent(contactText);
    const tgUrl = "https://t.me/" + TG_USERNAME;

    const subject = `Product question: ${(product.asin||"").trim()} [${(product.market||"").toUpperCase()}]`;
    const mailUrl = "mailto:" + encodeURIComponent(EMAIL_CONTACT)
      + "?subject=" + encodeURIComponent(subject)
      + "&body=" + encodeURIComponent(contactText);

    const waBtn = document.getElementById("contactWA");
    waBtn.href = waUrl;
    waBtn.onclick = (e) => { e.preventDefault(); window.open(waUrl, "_blank", "noopener,noreferrer"); };

    const tgBtn = document.getElementById("contactTG");
    tgBtn.href = tgUrl;
    tgBtn.onclick = (e) => {
      e.preventDefault();
      copyText(contactText)
        .then(() => window.open(tgUrl, "_blank", "noopener,noreferrer"))
        .catch(() => window.open(tgUrl, "_blank", "noopener,noreferrer"));
    };

    const mailBtn = document.getElementById("contactMail");
    mailBtn.href = mailUrl;
    mailBtn.onclick = (e) => { e.preventDefault(); window.open(mailUrl, "_blank", "noopener,noreferrer"); };

    document.getElementById("contactModal").style.display = "block";
  }

  function closeContactModal(){
    document.getElementById("contactModal").style.display = "none";
    CURRENT_CONTACT_PRODUCT = null;
  }

  function copyContactInfo(){
    const text = document.getElementById("contactPreview").textContent || "";
    if (!text) return;
    copyText(text).then(() => alert("Copied!")).catch(() => alert("Copy failed"));
  }

  window.onload = function(){
    const saved = localStorage.getItem("selectedCountry");
    if (saved) document.getElementById("countrySelect").value = saved;

    fetchProductData(false);
    setInterval(() => fetchProductData(false), AUTO_REFRESH_MS);
  };
</script>
</body>
</html>
