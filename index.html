<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Product List</title>
<style>
  :root{
    --bg:#f4f4f9;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --dark:#111827;
  }

  body{ font-family: Arial, sans-serif; margin:0; padding:0; background:var(--bg); color:var(--text); }
  header{ background:linear-gradient(135deg,#0f172a,#020617); color:#fff; text-align:center; padding:20px 0; border-bottom:5px solid #fff; }
  header h1{ font-size:2em; font-weight:800; margin:0 0 10px 0; letter-spacing:.3px; }
  .country-select{
    margin:10px; font-size:1.05em; padding:6px 10px; background:#fff; color:#111827;
    border:1px solid #ddd; border-radius:8px; outline:none;
  }

  section#product-list{ max-width:1200px; margin:18px auto 30px; padding:0 12px; }
  section#product-list h2{ margin:0 0 10px 0; font-size:20px; }

  .status-bar{
    display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    padding:10px 12px; background:var(--card); border:1px solid var(--border); border-radius:12px; margin-bottom:10px;
  }
  .status-left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .badge{ padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#f9fafb; font-size:12px; color:#374151; }
  .muted{ color:var(--muted); font-size:12px; }

  .requirements-box{
    background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; margin:10px 0 14px;
  }
  .requirements-box h3{ margin:0 0 8px 0; font-size:16px; }
  .requirements-box ul{ margin:0 0 0 18px; padding:0; line-height:1.6; }

  .btn{
    padding:8px 12px; border-radius:10px; border:1px solid var(--border);
    background:var(--dark); color:#fff; cursor:pointer; font-weight:700; font-size:13px; white-space:nowrap;
  }
  .btn:hover{ opacity:.92; }

  /* ================== 九宫格 Grid ================== */
  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:14px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 640px){
    .grid{ grid-template-columns: repeat(1, minmax(0, 1fr)); }
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow: 0 6px 18px rgba(0,0,0,.04);
  }

  .image-wrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:10px;
  }

  /* 图片占主要空间 */
  .product-image{
    width:100%;
    max-width:320px;
    aspect-ratio: 1 / 1;
    object-fit:contain;
    cursor:pointer;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff;
    transition: transform .12s ease;
    display:block;
  }
  .product-image:hover{ transform: scale(1.02); }

  .asin-under{
    font-weight:800;
    font-size:12px;
    letter-spacing:.35px;
    color:var(--text);
    background:#f3f4f6;
    border:1px solid var(--border);
    border-radius:999px;
    padding:4px 10px;
    max-width: 100%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* ✅ Forward 放在图片下方 */
  .forward-wrap{
    width:100%;
    display:flex;
    justify-content:center;
  }
  .forward-btn{
    width: min(220px, 100%);
  }

  .empty{
    margin-top:14px;
    padding:16px 12px;
    color:var(--muted);
    font-size:14px;
    text-align:center;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
  }

  /* ================== Modal ================== */
  .modal{
    display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
    background:rgba(0,0,0,.7); padding-top:60px;
  }
  .modal-inner{
    width:90%; max-width:560px; margin:0 auto; position:relative; background:#fff; border-radius:14px; padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  .close{
    position:absolute; top:10px; right:14px; color:#111827; font-size:26px; font-weight:bold;
    cursor:pointer; user-select:none; line-height:1;
  }
  .close:hover{ opacity:.7; }

  .contact-btn{
    display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px;
    background:#fff; color:#111827; text-decoration:none; border:1px solid var(--border);
    font-weight:700; font-size:14px;
  }
  .contact-btn:hover{ opacity:.92; }
</style>
</head>

<body>
<header>
  <h1 id="pageTitle">Product List</h1>
  <select class="country-select" id="countrySelect" onchange="onMarketChange()">
    <option value="UK">UK</option>
    <option value="US">US</option>
    <option value="DE">Germany</option>
    <option value="FR">France</option>
    <option value="IT">Italy</option>
    <option value="ES">Spain</option>
    <option value="CA">Canada</option>
    <option value="JP">Japan</option>
  </select>
</header>

<section id="product-list">
  <h2 id="productsTitle">Products</h2>

  <div class="status-bar">
    <div class="status-left">
      <span class="badge" id="statusBadge">Loading…</span>
      <span class="muted" id="statusMeta"></span>
    </div>
    <button class="btn" id="refreshBtn" onclick="fetchProductData(true)">Refresh</button>
  </div>

  <div class="requirements-box" id="requirementsBox">
    <h3 id="requirementsTitle">Amazon Associates Requirements</h3>
    <ul id="requirementsList">
      <li>As an Amazon Associate, we earn from qualifying purchases.</li>
      <li>All product links must direct to Amazon product pages.</li>
      <li>We do not request or accept paid reviews or incentives.</li>
      <li>Buyers should follow Amazon policies and terms when purchasing.</li>
      <li>For inquiries, please use the Forward button on each product to consult.</li>
    </ul>
  </div>

  <!-- ✅ 九宫格容器 -->
  <div class="grid" id="productGrid"></div>

  <div class="empty" id="emptyHint" style="display:none;">
    No products loaded. If this is your first time, run GitHub Actions once to generate products.json.
  </div>
</section>

<!-- Forward Modal -->
<div class="modal" id="forwardModal" onclick="closeForwardModal(event)">
  <div class="modal-inner" onclick="event.stopPropagation()">
    <span class="close" onclick="closeForwardModal(event)">×</span>
    <h3 id="forwardTitle" style="margin:0 0 10px 0;">Forward Product</h3>
    <div id="forwardSub" style="font-size:13px;color:#6b7280;margin-bottom:8px;">
      Choose a channel. A new window will open; this page will stay here.
    </div>
    <div id="forwardPreview" style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f9fafb;white-space:pre-wrap;font-size:13px;line-height:1.4;text-align:left;"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;">
      <button class="btn" id="copyBtn" onclick="copyForwardText()" style="background:#374151;">Copy Text</button>
      <a class="contact-btn" href="#" id="forwardWA" rel="noopener" target="_blank">WhatsApp</a>
      <a class="contact-btn" href="#" id="forwardTG" rel="noopener" target="_blank">Telegram</a>
      <a class="contact-btn" href="#" id="forwardMail" rel="noopener" target="_blank">Email</a>
    </div>
  </div>
</div>

<script>
  // ===== Config =====
  const PRODUCTS_JSON_PATH = "./products.json";

  const WA_PHONE = "8615778673666";
  const TG_USERNAME = "dalemyrong";
  const EMAIL_CONTACT = "info@dalemy.top";
  const AUTO_REFRESH_MS = 60 * 1000;

  // ===== State =====
  let ALL_PRODUCTS = [];
  let LAST_LOADED_AT = null;
  let CURRENT_FORWARD_PRODUCT = null;

  // ===== Language mapping =====
  const LANG_BY_MARKET = { US:"en", UK:"en", CA:"en", DE:"de", FR:"fr", IT:"it", ES:"es", JP:"ja" };

  // ===== i18n UI =====
  const UI_I18N = window.UI_I18N || {
    en: {
      pageTitle: "Product List",
      productsTitle: "Products",
      refresh: "Refresh",
      forwardTitle: "Forward Product",
      forwardSub: "Choose a channel. A new window will open; this page will stay here.",
      copy: "Copy Text",
      labels: { market:"Market", link:"Link", asin:"ASIN" }
    }
  };

  function setStatus(text, meta = "") {
    document.getElementById("statusBadge").textContent = text;
    document.getElementById("statusMeta").textContent = meta;
  }
  function showEmptyHint(show) {
    document.getElementById("emptyHint").style.display = show ? "block" : "none";
  }
  function currentMarket() {
    return (document.getElementById("countrySelect").value || "UK").toUpperCase();
  }
  function currentLang() {
    return LANG_BY_MARKET[currentMarket()] || "en";
  }
  function tUI() {
    return UI_I18N[currentLang()] || UI_I18N.en;
  }

  function normalizeUrl(u) {
    const s = String(u || "").trim();
    if (!s) return "";
    if (/^https?:\/\//i.test(s)) return s;
    return "";
  }

  // 点击图片：跳转产品链接
  function openProductLink(product) {
    const url = normalizeUrl(product && product.link);
    if (!url) {
      alert("This product has no valid link.");
      return;
    }
    window.open(url, "_blank", "noopener");
  }

  function applyI18n() {
    const T = tUI();
    document.getElementById("pageTitle").textContent = T.pageTitle;
    document.getElementById("productsTitle").textContent = T.productsTitle;
    document.getElementById("refreshBtn").textContent = T.refresh;

    document.getElementById("forwardTitle").textContent = T.forwardTitle;
    document.getElementById("forwardSub").textContent = T.forwardSub;
    document.getElementById("copyBtn").textContent = T.copy;
  }

  function fetchProductData(manual = false) {
    const url = PRODUCTS_JSON_PATH + "?ts=" + Date.now();
    setStatus(manual ? "Refreshing…" : "Loading…", "Fetching products.json");

    fetch(url, { cache: "no-store" })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        return res.json();
      })
      .then(products => {
        if (!Array.isArray(products)) throw new Error("products.json is not an array");

        ALL_PRODUCTS = products.map((p, idx) => ({ ...p, __idx: idx }));
        LAST_LOADED_AT = new Date();

        renderGrid();
        applyI18n();

        setStatus("Loaded", `${products.length} items · ${LAST_LOADED_AT.toLocaleString()}`);
        showEmptyHint(products.length === 0);
      })
      .catch(err => {
        console.error("Failed to load products.json:", err);
        setStatus("Load failed", err.message);
        showEmptyHint(true);
        if (manual) alert("Failed to load products.json.\n\n" + err.message);
      });
  }

  function getVisibleProducts() {
    const m = currentMarket();
    return ALL_PRODUCTS
      .filter(p => String(p.market || "").trim().toUpperCase() === m)
      .sort((a, b) => (a.__idx ?? 0) - (b.__idx ?? 0));
  }

  function renderGrid() {
    const visibleList = getVisibleProducts();
    displayProducts(visibleList);

    if (LAST_LOADED_AT) {
      setStatus(
        "Loaded",
        `${visibleList.length}/${ALL_PRODUCTS.length} visible · ${LAST_LOADED_AT.toLocaleString()}`
      );
    }
  }

  function displayProducts(products) {
    const grid = document.getElementById("productGrid");
    grid.innerHTML = "";

    products.forEach(product => {
      const card = document.createElement("div");
      card.className = "card";

      const asin = (product.asin || "").trim();
      const img  = (product.image_url || "").trim();
      const safeTitle = escapeHtml(product.title || "");

      card.innerHTML = `
        <div class="image-wrap">
          ${img ? `
            <img
              src="${escapeAttr(img)}"
              alt="${safeTitle}"
              class="product-image"
              onclick='openProductLink(${encodeProductForOnclick(product)})'
            />
          ` : `
            <div class="product-image" style="display:flex;align-items:center;justify-content:center;color:#6b7280;">
              No Image
            </div>
          `}
          <div class="asin-under" title="${escapeAttr(asin)}">${escapeHtml(asin || "-")}</div>

          <div class="forward-wrap">
            <button class="btn forward-btn" onclick='openForwardModal(${encodeProductForOnclick(product)})'>Forward</button>
          </div>
        </div>
      `;

      grid.appendChild(card);
    });

    showEmptyHint(products.length === 0);
  }

  function encodeProductForOnclick(product) {
    const safe = {
      market: product.market || "",
      asin: product.asin || "",
      title: product.title || "",
      link: product.link || "",
      image_url: product.image_url || "",
      __idx: product.__idx ?? 0
    };
    return JSON.stringify(safe)
      .replaceAll("&", "\\u0026")
      .replaceAll("<", "\\u003c")
      .replaceAll(">", "\\u003e");
  }

  function onMarketChange() {
    renderGrid();
    applyI18n();
    localStorage.setItem("selectedCountry", currentMarket());
  }

  function copyText(text) {
    if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
    return new Promise((resolve, reject) => {
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        resolve();
      } catch (e) { reject(e); }
    });
  }

  async function openForwardModal(product) {
    CURRENT_FORWARD_PRODUCT = product;

    const market = (product.market || "").trim().toUpperCase();
    const lang = LANG_BY_MARKET[market] || "en";
    const T = UI_I18N[lang] || UI_I18N.en;

    const text = buildForwardTextLocalized(product, T.labels, market);
    document.getElementById("forwardPreview").textContent = text;

    const waUrl = "https://wa.me/" + WA_PHONE + "?text=" + encodeURIComponent(text);
    const waBtn = document.getElementById("forwardWA");
    waBtn.href = waUrl;
    waBtn.onclick = (e) => { e.preventDefault(); window.open(waUrl, "_blank", "noopener"); };

    const tgUrl = "https://t.me/" + TG_USERNAME;
    const tgBtn = document.getElementById("forwardTG");
    tgBtn.href = tgUrl;
    tgBtn.onclick = (e) => {
      e.preventDefault();
      copyText(text).finally(() => window.open(tgUrl, "_blank", "noopener"));
    };

    const subject = `[${market}] ${product.title || "Product"}`.trim();
    const mailUrl =
      "mailto:" + encodeURIComponent(EMAIL_CONTACT) +
      "?subject=" + encodeURIComponent(subject) +
      "&body=" + encodeURIComponent(text);

    const mailBtn = document.getElementById("forwardMail");
    mailBtn.href = mailUrl;
    mailBtn.onclick = (e) => { e.preventDefault(); window.open(mailUrl, "_blank", "noopener"); };

    document.getElementById("forwardTitle").textContent = T.forwardTitle;
    document.getElementById("forwardSub").textContent = T.forwardSub;
    document.getElementById("copyBtn").textContent = T.copy;

    document.getElementById("forwardModal").style.display = "block";
  }

  function closeForwardModal(e) {
    document.getElementById("forwardModal").style.display = "none";
    CURRENT_FORWARD_PRODUCT = null;
  }

  // ✅ 复制文本包含 ASIN（按你要求）
  function buildForwardTextLocalized(p, labels, market) {
    const lines = [];
    if (p.title) lines.push(p.title);

    const asin = (p.asin || "").trim();
    if (asin) lines.push(`${labels.asin || "ASIN"}: ${asin}`);

    lines.push(`${labels.market || "Market"}: ${market || "-"}`);
    if (p.link) lines.push(`${labels.link || "Link"}: ${p.link}`);

    return lines.join("\n");
  }

  function copyForwardText() {
    const text = document.getElementById("forwardPreview").textContent || "";
    if (!text) return;
    copyText(text).then(() => alert("Copied!")).catch(() => alert("Copy failed"));
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function escapeAttr(str) { return escapeHtml(str); }

  window.onload = function () {
    const savedCountry = localStorage.getItem("selectedCountry");
    document.getElementById("countrySelect").value = savedCountry || "UK";

    applyI18n();
    fetchProductData(false);
    setInterval(() => fetchProductData(false), AUTO_REFRESH_MS);
  };
</script>
</body>
</html>
