<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Product Picks</title>
<meta name="description" content="Independent product references. As an Amazon Associate, we earn from qualifying purchases.">
<link rel="canonical" href="https://ama.omino.top/">

<style>
  :root{
    --bg:#f4f4f9;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --primary:#111827;
    --soft:#f9fafb;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }

  header{
    background:linear-gradient(135deg,#0f172a,#020617);
    color:#fff; text-align:center;
    padding:22px 12px 14px;
  }
  header h1{ margin:0 0 8px 0; font-size:2em; font-weight:800; letter-spacing:.2px; }
  .topbar{
    display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
    padding:0 12px 6px;
  }
  .country-select, .search-input{
    font-size:14px; padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; outline:none;
  }
  .search-input{ min-width:min(420px, 90vw); }
  .wrap{ max-width:1200px; margin:14px auto 26px; padding:0 12px; }

  .hero{
    margin-top:12px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 14px;
    line-height:1.6;
  }
  .hero .title{
    font-size:14px;
    font-weight:900;
    color:#111827;
    margin:0 0 6px 0;
  }
  .hero .desc{
    font-size:12px;
    color:#374151;
    margin:0;
  }
  .hero .desc strong{ font-weight:900; }
  .hero .hint{
    margin-top:8px;
    font-size:12px;
    color:#4b5563;
  }
  .hero .hint a{ color:#2563eb; text-decoration:none; }

  .compliance{
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 14px;
    line-height:1.55;
    margin-top:12px;
  }
  .compliance .row{
    display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:flex-start;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--soft);
    font-size:12px; color:#374151;
    white-space:nowrap;
  }
  .compliance strong{ font-weight:800; }
  .compliance .small{ font-size:12px; color:#4b5563; margin-top:8px; }
  .compliance a{ color:#2563eb; text-decoration:none; }

  .status-bar{
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
    margin-top:12px;
    background:#fff; border:1px solid var(--border); border-radius:14px;
    padding:10px 12px;
  }
  .badge{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:var(--soft); }
  .muted{ color:var(--muted); font-size:12px; }
  .btn{
    cursor:pointer; border-radius:12px; border:1px solid var(--border);
    padding:9px 12px; font-weight:800; font-size:13px;
    background:var(--primary); color:#fff;
  }
  .btn:hover{ opacity:.92; }
  .btn.secondary{ background:#fff; color:#111827; }

  .howto{
    margin-top:12px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 14px;
  }
  .howto h2{ margin:0 0 8px 0; font-size:16px; }
  .howto .cols{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
  }
  @media(max-width:780px){ .howto .cols{ grid-template-columns:1fr; } }
  .howto .item{
    background:var(--soft);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 10px;
  }
  .howto .item h3{ margin:0 0 6px 0; font-size:13px; }
  .howto .item p{ margin:0; font-size:12px; color:#374151; line-height:1.55; }
  .howto .note{
    margin-top:10px;
    font-size:12px;
    color:#4b5563;
    line-height:1.6;
  }

  .grid{
    margin-top:14px;
    display:grid;
    grid-template-columns:repeat(3, minmax(0, 1fr));
    gap:14px;
  }
  @media (max-width: 980px){ .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 640px){ .grid{ grid-template-columns:repeat(1, minmax(0, 1fr)); } }

  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.04);
  }
  .image-wrap{
    display:flex; flex-direction:column; align-items:center; gap:10px;
  }
  .product-image{
    width:100%;
    max-width:360px;
    aspect-ratio:1/1;
    object-fit:contain;
    border-radius:16px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    transition: transform .12s ease;
    display:block;
  }
  .product-image:hover{ transform:scale(1.02); }

  .why{
    width:100%;
    max-width:360px;
    margin-top:4px;
    padding:8px 10px;
    background:#f9fafb;
    border:1px solid #e5e7eb;
    border-radius:12px;
    font-size:12px;
    color:#374151;
    line-height:1.55;
  }
  .why strong{ font-weight:800; }
  .why .subtle{ color:#4b5563; }

  .actions{
    width:100%;
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:2px;
  }
  .cta{
    width:min(260px, 100%);
    text-align:center;
    text-decoration:none;
    display:inline-flex;
    justify-content:center;
    align-items:center;
  }

  .empty{
    margin-top:14px;
    padding:14px;
    border:1px solid var(--border);
    border-radius:14px;
    background:#fff;
    color:var(--muted);
    text-align:center;
    font-size:14px;
  }

  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); padding-top:60px; z-index:999; }
  .modal-inner{
    width:90%; max-width:560px; margin:0 auto;
    background:#fff; border-radius:16px; padding:14px; position:relative;
    box-shadow:0 10px 30px rgba(0,0,0,.18);
  }
  .close{
    position:absolute; right:14px; top:10px; font-size:26px; font-weight:900; cursor:pointer; user-select:none;
  }
  .contact-btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 14px; border-radius:12px;
    background:#fff; color:#111827; text-decoration:none; border:1px solid var(--border);
    font-weight:900; font-size:14px;
  }
  .contact-btn:hover{ background:#f9fafb; }
  .mini-hint{ margin-top:10px;font-size:12px;color:#6b7280;line-height:1.55; }

  footer{
    margin-top:18px;
    background:#fff; border-top:1px solid var(--border);
    padding:16px 12px;
  }
  footer .inner{ max-width:1200px; margin:0 auto; font-size:12px; color:#374151; line-height:1.7; }
  footer a{ color:#2563eb; text-decoration:none; }

  /* ====== Detail Page ====== */
  .detail-wrap{ margin-top:14px; }
  .detail-top{
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
    background:#fff; border:1px solid var(--border); border-radius:14px;
    padding:10px 12px;
  }
  .detail-head{ display:flex; flex-direction:column; gap:4px; }
  .detail-title{ font-weight:900; font-size:14px; margin:0; }
  .detail-sub{ font-size:12px; color:#6b7280; margin:0; }
  .detail-card{
    margin-top:12px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.04);
  }
  .detail-image{
    width:100%;
    max-width:520px;
    aspect-ratio:1/1;
    object-fit:contain;
    border-radius:16px;
    border:1px solid var(--border);
    background:#fff;
    display:block;
    margin:0 auto;
  }
  .detail-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
  .detail-note{
    margin-top:10px;
    font-size:12px; color:#4b5563; line-height:1.55;
    background:var(--soft);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
  }

    /* ===== Mobile overflow-x fix (no horizontal drag) ===== */
    html, body { max-width: 100%; overflow-x: hidden; }
    img, video, canvas, svg { max-width: 100%; height: auto; }
    pre, code { white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere; }
    /* Avoid 100vw + padding causing overflow on some mobile browsers */
    .wrap, header, main, footer { width: 100%; max-width: 100%; }


  /* ===== Fold (collapsible) controls (keep layout; default expanded; remember state) ===== */
  .fold-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .fold-btn{
    cursor:pointer;
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    font-weight:800;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    white-space:nowrap;
  }
  .fold-btn:hover{ background:#f9fafb; }
  .fold-hidden{ display:none !important; }

</style>
</head>
<body>
<script>

  // ==================== CANONICAL URL CLEAN (remove ?dst / ?to) ====================
  // Goal:
  // 1) Direct-open /p/{market}/{asin}?dst=... should end up with address bar as /p/{market}/{asin}
  // 2) Landing /?to=/p/{market}/{asin}&dst=... should also end up as /p/{market}/{asin}
  // The dst value is preserved in sessionStorage for the product page to use.
  (function canonicalClean() {
    try {
      var sp = new URLSearchParams(location.search || "");
      var dst = (sp.get("dst") || "").trim();
      var to = (sp.get("to") || "").trim();
      // store dst for later use
      if (dst) {
        // keep a per-path key so different products won't overwrite each other
        try { sessionStorage.setItem("dst:" + (to || location.pathname), dst); } catch(e){}
        try { sessionStorage.setItem("dst:last", dst); } catch(e){}
      }

      // If we are on /?to=... => normalize to the "to" path (no query)
      if (to && to.startsWith("/p/")) {
        try { history.replaceState({}, "", to); } catch(e){}
        return;
      }

      // If we are already on /p/... with ?dst=... => strip query
      if ((location.pathname || "").startsWith("/p/") && (sp.has("dst") || sp.has("to"))) {
        try { history.replaceState({}, "", location.pathname); } catch(e){}
      }
    } catch (e) {}
  })();
  // ==================== END CANONICAL URL CLEAN ====================


(function () {
  try {
    var p = location.pathname || "/";
    if (p === "/index.html") history.replaceState({}, "", "/");
  } catch (e) {}
})();
</script>


<header>
  <h1 id="headerTitle">Product Picks</h1>
  <div class="topbar" id="topbar">
    <select class="country-select" id="countrySelect" onchange="onMarketChange()">
      <option value="US">US</option>
      <option value="UK">UK</option>
      <option value="DE">DE</option>
      <option value="FR">FR</option>
      <option value="IT">IT</option>
      <option value="ES">ES</option>
      <option value="CA">CA</option>
      <option value="JP">JP</option>
    </select>
    <input class="search-input" id="searchInput" placeholder="Search by ASIN…" oninput="renderGrid()"/>
  </div>
</header>

<div class="wrap" id="app">

  <section class="hero" id="heroBlock" aria-label="Independent product reference">
    <div class="fold-row"><div class="title">Independent product reference</div><button class="fold-btn" id="heroFoldBtn" type="button" onclick="toggleFold('hero')">Collapse</button></div>
    <div id="heroFoldBody">
    <p class="desc">
      This website provides independent product identifiers and references to items available on Amazon.
      <strong>All purchases are completed on Amazon</strong> via the product pages.
      We do not sell products directly and do not process orders, payments, warranties, or returns.
    </p>
    <div class="hint">
      Need help identifying an item? Use <strong>Contact / Copy</strong> to copy ASIN / Market and reach us for general assistance (non-purchase support).
      See <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a> and <a href="./terms.html" target="_blank" rel="noopener">Terms</a>.
    </div>
    </div>
  </section>

  <div class="compliance" id="complianceBlock">
    <div class="row">
      <div class="pill"><strong>Disclosure</strong>: As an Amazon Associate, we earn from qualifying purchases.</div>
      <div class="pill">Independent site · Not endorsed by Amazon</div>
    </div>
    <div class="small">
      Amazon and the Amazon logo are trademarks of Amazon.com, Inc. or its affiliates. We provide independent product references and redirect you to Amazon for purchase. Product details, pricing, availability, shipping, and return terms are determined by Amazon on the destination page.
      See <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a> and <a href="./terms.html" target="_blank" rel="noopener">Terms</a>.
    </div>
  </div>

  <div class="status-bar" id="statusBar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <span class="badge" id="statusBadge">Loading…</span>
      <span class="muted" id="statusMeta"></span>
    </div>
    <button class="btn" onclick="fetchAllData(true)">Refresh</button>
  </div>

  <div class="howto" id="howtoBlock">
    <div class="fold-row"><h2 style="margin:0;">How to choose</h2><button class="fold-btn" id="howtoFoldBtn" type="button" onclick="toggleFold('howto')">Collapse</button></div>
    <div id="howtoFoldBody">
    <div class="cols">
      <div class="item">
        <h3>1) Confirm compatibility</h3>
        <p>Before buying, confirm model/size/region compatibility on the Amazon product page, especially for electronics, consumables, and replacement parts.</p>
      </div>
      <div class="item">
        <h3>2) Check seller & fulfillment</h3>
        <p>Prefer reputable sellers and reliable fulfillment methods. Review shipping speed, return policy, and warranty terms on Amazon.</p>
      </div>
      <div class="item">
        <h3>3) Compare variants</h3>
        <p>Many products have variants (color, bundle, capacity). Make sure you select the correct variant on Amazon before checkout.</p>
      </div>
      <div class="item">
        <h3>4) Read recent reviews</h3>
        <p>Focus on recent verified purchase reviews. Pay attention to recurring issues rather than single outliers.</p>
      </div>
    </div>
    <div class="note">
      Note: We do not guarantee pricing or availability. Final product details, pricing, and purchase terms are provided by Amazon on the destination page.
    </div>
    </div>
  </div>

  <div class="grid" id="productGrid"></div>
  <div class="empty" id="emptyHint" style="display:none;"></div>
  <div id="detailPage" style="display:none;"></div>

</div>

<div class="modal" id="contactModal" onclick="closeContactModal()">
  <div class="modal-inner" onclick="event.stopPropagation()">
    <span class="close" onclick="closeContactModal()">×</span>

    <h3 style="margin:0 0 10px 0;">Contact & Copy</h3>
    <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">
      Copy only ASIN / Market. Contact options are for general consultation and do not provide purchase support; use “View on Amazon” to purchase.
    </div>

    <div id="contactPreview"
         style="border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#f9fafb;white-space:pre-wrap;font-size:13px;line-height:1.45;text-align:left;"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;">
      <button class="btn" onclick="copyContactInfo()" style="background:#374151;">Copy info</button>
      <a class="contact-btn" href="#" id="contactWA" rel="noopener noreferrer" target="_blank">WhatsApp</a>
      <a class="contact-btn" href="#" id="contactTG" rel="noopener noreferrer" target="_blank">Telegram</a>
      <a class="contact-btn" href="#" id="contactMail" rel="noopener noreferrer" target="_blank">Email</a>
      <button class="btn secondary" onclick="closeContactModal()">Close</button>
    </div>

    <div class="mini-hint">
      For purchase, use the “View on Amazon” button. Final pricing and availability are provided by Amazon on the destination page.
    </div>
  </div>
</div>

<footer id="footer">
  <div class="inner">
    <div><strong>Affiliate disclosure:</strong> As an Amazon Associate, we earn from qualifying purchases.</div>
    <div><strong>Independence:</strong> This site is not an official Amazon website and is not endorsed by Amazon.</div>
    <div><strong>Links:</strong> “View on Amazon” redirects to Amazon. Amazon may use cookies for tracking qualifying purchases.</div>
    <div style="margin-top:6px;">
      <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a> ·
      <a href="./terms.html" target="_blank" rel="noopener">Terms</a>
    </div>
    <div style="margin-top:6px;">© 2025 ama.omino.top</div>
  </div>
</footer>

<script>
  // ===================== BUILD MARK (for cache verification) =====================
  const BUILD_VERSION = "2026-01-01-multi-platform-detail-archive-search";

  // ===================== FOLD (collapsible) STATE (NEW) =====================
  // Default: expanded. User toggle is remembered in localStorage.
  const FOLD_KEYS = {
    hero: "plist_fold_hero_v1",
    howto: "plist_fold_howto_v1"
  };

  function applyFoldState(section, collapsed){
    try{
      const isCollapsed = !!collapsed;

      if (section === "hero"){
        const body = document.getElementById("heroFoldBody");
        const btn = document.getElementById("heroFoldBtn");
        if (body) body.classList.toggle("fold-hidden", isCollapsed);
        if (btn) btn.textContent = isCollapsed ? "Expand" : "Collapse";
        if (btn) btn.setAttribute("aria-expanded", String(!isCollapsed));
      }

      if (section === "howto"){
        const body = document.getElementById("howtoFoldBody");
        const btn = document.getElementById("howtoFoldBtn");
        if (body) body.classList.toggle("fold-hidden", isCollapsed);
        if (btn) btn.textContent = isCollapsed ? "Expand" : "Collapse";
        if (btn) btn.setAttribute("aria-expanded", String(!isCollapsed));
      }
    }catch(e){}
  }

  function toggleFold(section){
    try{
      const key = FOLD_KEYS[section];
      if (!key) return;

      const current = (localStorage.getItem(key) || "0") === "1";
      const next = !current;
      localStorage.setItem(key, next ? "1" : "0");
      applyFoldState(section, next);
    }catch(e){}
  }

  function restoreFoldStates(){
    try{
      const heroCollapsed = (localStorage.getItem(FOLD_KEYS.hero) || "0") === "1";
      const howtoCollapsed = (localStorage.getItem(FOLD_KEYS.howto) || "0") === "1";
      applyFoldState("hero", heroCollapsed);
      applyFoldState("howto", howtoCollapsed);
    }catch(e){}
  }
  // ===================== END FOLD STATE (NEW) =====================

  console.log("[build]", BUILD_VERSION);

  // ===================== LIST SCROLL MEMORY (NEW) =====================
  // 目标：从列表进入独立页后，返回列表仍回到原滚动位置
  // 只影响“列表 <-> 独立页”的往返，不改你的其它功能/排序/筛选
  const LIST_SCROLL_KEY = "plist_scroll_y_v1";
  const LIST_RESTORE_FLAG_KEY = "plist_restore_flag_v1";

  // 交给我们自己恢复滚动位置（避免浏览器默认策略与动态渲染冲突）
  if ("scrollRestoration" in history) {
    try { history.scrollRestoration = "manual"; } catch(e){}
  }

  function saveListScrollPos(){
    try{
      // 仅在列表视图下保存
      const route = parseRoute();
      if (route.type !== "list") return;
      sessionStorage.setItem(LIST_SCROLL_KEY, String(window.scrollY || 0));
      sessionStorage.setItem(LIST_RESTORE_FLAG_KEY, "1");
    }catch(e){}
  }

  function restoreListScrollPosIfNeeded(){
    try{
      // 仅在列表视图恢复
      const route = parseRoute();
      if (route.type !== "list") return;

      const flag = sessionStorage.getItem(LIST_RESTORE_FLAG_KEY);
      if (flag !== "1") return;

      const y = Number(sessionStorage.getItem(LIST_SCROLL_KEY) || "0");
      // 清 flag：避免用户刷新/首次打开也被强制滚动
      sessionStorage.removeItem(LIST_RESTORE_FLAG_KEY);

      if (!Number.isFinite(y) || y <= 0) return;

      // 等 DOM 渲染完成再滚动（否则会被后续 render 覆盖）
      requestAnimationFrame(() => {
        window.scrollTo({ top: y, behavior: "instant" });
      });
    }catch(e){}
  }
  // ===================== END LIST SCROLL MEMORY (NEW) =====================

  // ====== FIX (A): support /?to=/p/{market}/{asin} landing (generated by /p pages) ======
  (function bridgeToParam() {
  try {
    var sp = new URLSearchParams(location.search || "");
    var to = sp.get("to");
    if (!to) return;

    // Optional destination link (non-Amazon platforms) passed from generated /p pages:
    // /?to=/p/us/123&dst=https%3A%2F%2Fwww.walmart.com%2F...
    var dst = sp.get("dst") || "";

    to = decodeURIComponent(to);
    if (!to) return;

    if (String(to).toLowerCase().indexOf("/p/") !== 0) return;

    // Preserve dst by moving it onto the /p/... URL as query string.
    // This keeps your existing routing logic intact and enables the detail CTA to use dst.
    var newUrl = to;
    if (dst) {
      try { dst = decodeURIComponent(dst); } catch(e) {}
      newUrl = to + (to.indexOf("?") >= 0 ? "&" : "?") + "dst=" + encodeURIComponent(dst);
    }

    history.replaceState(null, "", newUrl);
  } catch (e) {}
})();

  // ====== END FIX (A) ======

  /**
   * Data files (must be at site root)
   * - products.json: active list (listing uses this only)
   * - archive.json : removed/offline items (detail fallback + re-listed prioritization)
   */
  const PRODUCTS_JSON_PATH = "/products.json";
  const ARCHIVE_JSON_PATH  = "/archive.json";

  const WA_PHONE = "8615778673666";
  const TG_USERNAME = "dalemyrong";
  const EMAIL_CONTACT = "info@dalemy.top";

  const AUTO_REFRESH_MS = 60 * 1000;

  const ENABLE_GEO_IP_AUTO_MARKET = true;
  const ALLOWED_MARKETS = ["US","UK","DE","FR","IT","ES","CA","JP"];

  let ALL_PRODUCTS = [];
  let ARCHIVE_PRODUCTS = [];
  let LAST_LOADED_AT = null;
  let LAST_LOAD_ERROR = "";
  let IS_LOADING = false;

  let CURRENT_CONTACT_PRODUCT = null;

  const PLACEHOLDER_SVG = `
    <svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" viewBox="0 0 800 800">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#f3f4f6"/>
          <stop offset="1" stop-color="#e5e7eb"/>
        </linearGradient>
      </defs>
      <rect width="800" height="800" rx="48" fill="url(#g)"/>
      <rect x="180" y="220" width="440" height="300" rx="26" fill="#ffffff" stroke="#d1d5db" stroke-width="6"/>
      <circle cx="280" cy="310" r="34" fill="#e5e7eb"/>
      <path d="M210 490 L340 360 L430 450 L510 390 L590 490" fill="none" stroke="#d1d5db" stroke-width="14" stroke-linecap="round" stroke-linejoin="round"/>
      <text x="400" y="590" text-anchor="middle" font-family="Arial, sans-serif" font-size="34" fill="#6b7280">Image unavailable</text>
      <text x="400" y="640" text-anchor="middle" font-family="Arial, sans-serif" font-size="22" fill="#9ca3af">Placeholder</text>
    </svg>
  `;
  const PLACEHOLDER_DATA_URI = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(PLACEHOLDER_SVG);

// Read destination link from current URL query (?dst=...), used for multi-platform detail pages.
// If present and valid, it overrides product.link for the primary CTA.
function getDstFromLocation(){
  try{
    const sp = new URLSearchParams(location.search || "");
    const dst = String(sp.get("dst") || "").trim();
    return normalizeUrl(dst);
  }catch(e){
    return "";
  }
}


  function normalizeUrl(u){
    const s = String(u || "").trim();
    if (!s) return "";
    if (/^https?:\/\//i.test(s)) return s;
    return "";
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
  function setStatus(text, meta=""){
    document.getElementById("statusBadge").textContent = text;
    document.getElementById("statusMeta").textContent = meta;
  }

  function currentMarket(){
    return (document.getElementById("countrySelect").value || "US").toUpperCase();
  }
  function onMarketChange(){
    localStorage.setItem("selectedCountry", currentMarket());
    renderGrid();
  }

  function isHttpsPage(){ return String(location.protocol || "").toLowerCase() === "https:"; }
  function upgradeToHttps(url){ return String(url || "").replace(/^http:\/\//i, "https://"); }
  function toWeserv(url){
    const cleaned = String(url || "").replace(/^https?:\/\//i, "");
    return "https://images.weserv.nl/?url=" + encodeURIComponent(cleaned);
  }
  function initialImageUrl(raw){
    const u = normalizeUrl(raw);
    if (!u) return PLACEHOLDER_DATA_URI;
    return u;
  }
  function onImgError(imgEl){
    try{
      if (!imgEl) return;
      const stage = Number(imgEl.dataset.stage || "0");
      const original = String(imgEl.dataset.original || "");
      if (!original) { imgEl.src = PLACEHOLDER_DATA_URI; return; }

      if (stage === 0){
        imgEl.dataset.stage = "1";
        if (isHttpsPage() && /^http:\/\//i.test(original)){
          imgEl.src = upgradeToHttps(original);
          return;
        }
        imgEl.src = toWeserv(original);
        imgEl.dataset.stage = "2";
        return;
      }
      if (stage === 1){
        imgEl.dataset.stage = "2";
        imgEl.src = toWeserv(original);
        return;
      }
      imgEl.dataset.stage = "3";
      imgEl.src = PLACEHOLDER_DATA_URI;
      imgEl.removeAttribute("srcset");
    }catch(e){
      try{ imgEl.src = PLACEHOLDER_DATA_URI; }catch(_){}
    }
  }

  function isAllDigits(s){ return /^[0-9]+$/.test(String(s||"").trim()); }
  function shouldHideNonAmazonAsin(s){
    return isAllDigits(s);
  }

  
  function getDstForPath(pathname){
    try{
      var key = "dst:" + pathname;
      var v = sessionStorage.getItem(key) || sessionStorage.getItem("dst:last") || "";
      return (v || "").trim();
    }catch(e){}
    return "";
  }

function parseRoute(){
    const path = location.pathname || "/";
    let m = path.match(/^\/p\/([^\/]+)\/([^\/?#]+)(?:\/index\.html)?\/?$/i);
    if (m){
      return { type:"product", market: decodeURIComponent(m[1] || ""), key: decodeURIComponent(m[2] || "") };
    }

    try{
      const sp = new URLSearchParams(location.search || "");
      const toRaw = sp.get("to");
      if (toRaw){
        const to = decodeURIComponent(toRaw);
        const mm = String(to).match(/^\/p\/([^\/]+)\/([^\/?#]+)(?:\/index\.html)?\/?$/i);
        if (mm){
          return { type:"product", market: decodeURIComponent(mm[1] || ""), key: decodeURIComponent(mm[2] || "") };
        }
      }
    }catch(e){}

    return { type:"list" };
  }

  function normalizeAsin(a){ return String(a||"").trim().toUpperCase(); }
  function normalizeMarket(m){ return String(m||"").trim().toUpperCase(); }

  function splitAsinKey(key){
    const s = String(key||"").trim();
    const mm = s.match(/^([A-Za-z0-9]{8,20})(?:_(\d+))?$/);
    if (!mm) return { base: normalizeAsin(s), idx: 0 };
    const base = normalizeAsin(mm[1]);
    const idx = mm[2] ? Math.max(0, parseInt(mm[2], 10)) : 0;
    return { base, idx };
  }

  function buildProductPath(market, asinKey){
    const m = String(market||"").trim().toLowerCase();
    return `/p/${encodeURIComponent(m)}/${encodeURIComponent(String(asinKey||""))}/`;
  }
  function buildProductPermalink(market, asinKey){
    return location.origin + buildProductPath(market, asinKey);
  }

  function findProductByRoute(products, market, asinKey){
    const M = normalizeMarket(market);
    const { base, idx } = splitAsinKey(asinKey);
    const group = products.filter(p =>
      normalizeMarket(p.market) === M &&
      normalizeAsin(p.asin) === base
    );
    if (!group.length) return null;
    return group[idx] || null;
  }

  function showList(){
    document.getElementById("topbar").style.display = "flex";
    document.getElementById("heroBlock").style.display = "block";
    document.getElementById("complianceBlock").style.display = "block";
    document.getElementById("statusBar").style.display = "flex";
    document.getElementById("howtoBlock").style.display = "block";
    document.getElementById("productGrid").style.display = "grid";
    document.getElementById("detailPage").style.display = "none";
    document.getElementById("footer").style.display = "block";
    document.getElementById("headerTitle").textContent = "Product Picks";
    document.title = "Product Picks";
    // restore fold states (list view)
    restoreFoldStates();
  }

  function showDetail(){
    document.getElementById("topbar").style.display = "none";
    document.getElementById("heroBlock").style.display = "none";
    document.getElementById("complianceBlock").style.display = "none";
    document.getElementById("statusBar").style.display = "none";
    document.getElementById("howtoBlock").style.display = "none";
    document.getElementById("productGrid").style.display = "none";
    document.getElementById("emptyHint").style.display = "none";
    document.getElementById("detailPage").style.display = "block";
    document.getElementById("footer").style.display = "block";
  }

  function goHome(){
    // NEW: 返回列表时不强制回顶部，而是恢复到进入详情前的位置
    history.pushState({type:"list"}, "", "/");
    renderByRoute();

    // Ensure fold states applied after initial DOM is ready
    restoreFoldStates();
    restoreListScrollPosIfNeeded();
  }

  function goToProductPage(p){
    // NEW: 进入独立页前，先保存列表滚动位置（用于返回恢复）
    saveListScrollPos();

    const m = String(p.market||"").trim().toLowerCase();
    const asinKey = normalizeAsin(p.asin || "");
    if (!m || !asinKey) return;
    const path = buildProductPath(m, asinKey);
    history.pushState({type:"product", market:m, key:asinKey}, "", path);
    renderByRoute();
    window.scrollTo({top:0, behavior:"instant"});
  }

  async function fetchJsonNoCache(url){
    const u = url + (url.includes("?") ? "&" : "?") + "ts=" + Date.now();
    const res = await fetch(u, { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    return await res.json();
  }

  async function fetchAllData(manual=false){
    LAST_LOAD_ERROR = "";
    IS_LOADING = true;
    setStatus(manual ? "Refreshing…" : "Loading…", "Fetching products.json / archive.json");

    try{
      const [active, archived] = await Promise.allSettled([
        fetchJsonNoCache(PRODUCTS_JSON_PATH),
        fetchJsonNoCache(ARCHIVE_JSON_PATH)
      ]);

      if (active.status !== "fulfilled") throw active.reason;
      if (!Array.isArray(active.value)) throw new Error("products.json is not an array");

      // NOTE: Only minimal additions: keyword/store are kept so detail title can display them.
      ALL_PRODUCTS = active.value.map((p, idx) => ({
        _updated: Number(p._updated ?? 0),
        market: String(p.market ?? p.Market ?? p.MARKET ?? "").trim().toUpperCase(),
        asin: String(p.asin ?? p.ASIN ?? "").trim(),
        title: String(p.title ?? p.Title ?? "").trim(),
        keyword: String(p.keyword ?? p.Keyword ?? "").trim(),
        store: String(p.store ?? p.Store ?? "").trim(),
        link: String(p.link ?? p.Link ?? "").trim(),
        image_url: String(p.image_url ?? p.image ?? p.Image ?? "").trim(),
        __idx: idx
      }));

      if (archived.status === "fulfilled" && Array.isArray(archived.value)){
        ARCHIVE_PRODUCTS = archived.value.map((p, idx) => ({
          market: String(p.market ?? p.Market ?? p.MARKET ?? "").trim().toUpperCase(),
          asin: String(p.asin ?? p.ASIN ?? "").trim(),
          title: String(p.title ?? p.Title ?? "").trim(),
          keyword: String(p.keyword ?? p.Keyword ?? "").trim(),
          store: String(p.store ?? p.Store ?? "").trim(),
          link: String(p.link ?? p.Link ?? "").trim(),
          image_url: String(p.image_url ?? p.image ?? p.Image ?? "").trim(),
          __aidx: idx
        }));
      } else {
        ARCHIVE_PRODUCTS = [];
      }

      LAST_LOADED_AT = new Date();
      IS_LOADING = false;

      renderByRoute();

      const route = parseRoute();
      if (route.type === "list"){
        const visible = getVisibleProducts().length;
        setStatus("Loaded", `${visible}/${ALL_PRODUCTS.length} visible · ${currentMarket()} · ${LAST_LOADED_AT.toLocaleString()} · ${BUILD_VERSION}`);
      }
    }catch(err){
      console.error(err);
      LAST_LOAD_ERROR = err?.message || String(err);
      IS_LOADING = false;
      setStatus("Load failed", LAST_LOAD_ERROR);
      renderByRoute();
      if (manual) alert("Failed to load products.json.\n\n" + LAST_LOAD_ERROR);
    }
  }

  function keyOf(market, asin){
    return normalizeMarket(market) + "|" + normalizeAsin(asin);
  }

  function buildArchiveKeySet(){
    const s = new Set();
    for (const p of (ARCHIVE_PRODUCTS || [])){
      if (!p || !p.market || !p.asin) continue;
            s.add(keyOf(p.market, p.asin));
    }
    return s;
  }

  function dedupeByMarketAsinKeepFirst(list){
    const seen = new Set();
    const out = [];
    for (const p of list){
      const k = keyOf(p.market, p.asin);
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(p);
    }
    return out;
  }

  function getVisibleProducts(){
  const current = currentMarket();
  const qRaw = (document.getElementById("searchInput").value || "").trim();
  const q = qRaw.toLowerCase();

  const isDigitsQ = /^[0-9]+$/.test(qRaw);
  const archivedKeySet = buildArchiveKeySet();

  function matchQuery(p){
    if (!q) return true;

    const asin = String(p.asin || "").trim();
    const title = String(p.title || "").trim();
    const keyword = String(p.keyword || "").trim();
    const store = String(p.store || "").trim();
    const remark = String(p.remark || "").trim(); // 兼容：若数据里没有 remark 也不影响

    // 数字ID仅允许“精确完整搜索”出现
    if (asin && shouldHideNonAmazonAsin(asin)){
      return isDigitsQ && asin === qRaw;
    }

    // 统一包含匹配：支持中文标题/关键词/店铺等（中文不受 toLowerCase 影响）
    const haystack = [asin, title, keyword, store, remark]
      .filter(Boolean)
      .join(" | ")
      .toLowerCase();

    return haystack.includes(q);
  }

  // 搜索为空：保持原逻辑——只看当前 market（不变）
  if (!q){
    let list = (ALL_PRODUCTS || [])
      .filter(p => String(p.market || "").trim().toUpperCase() === current)
      .filter(p => !shouldHideNonAmazonAsin(p.asin))
      .map(p => ({...p, _archived:false}));

    list = dedupeByMarketAsinKeepFirst(list);

    list.sort((a, b) => {
      const ka = archivedKeySet.has(keyOf(a.market, a.asin)) ? 1 : 0;
      const kb = archivedKeySet.has(keyOf(b.market, b.asin)) ? 1 : 0;
      if (ka !== kb) return ka - kb;

      const ua = Number(a._updated || 0);
      const ub = Number(b._updated || 0);
      if (ub !== ua) return ub - ua;

      const ia = Number(a._idx || 0);
      const ib = Number(b._idx || 0);
      return ib - ia;
    });

    return list;
  }

  // 搜索非空：开启“全站搜索”（跨所有 market）
  let list = (ALL_PRODUCTS || [])
    .filter(matchQuery)
    .map(p => ({...p, _archived:false}));

  // 搜索时，把 archive 也拉进来（下架也可搜到并打开独立页）
  const archivedMatches = (ARCHIVE_PRODUCTS || [])
    .filter(matchQuery)
    .map(p => ({...p, _archived:true}));

  list = list.concat(archivedMatches);
  list = dedupeByMarketAsinKeepFirst(list);

  // 排序：上架优先，其次下架；再按更新时间/原顺序
  list.sort((a, b) => {
    const aa = a._archived ? 1 : 0;
    const bb = b._archived ? 1 : 0;
    if (aa !== bb) return aa - bb;

    const ua = Number(a._updated || 0);
    const ub = Number(b._updated || 0);
    if (ub !== ua) return ub - ua;

    const ia = Number(a._idx || 0);
    const ib = Number(b._idx || 0);
    return ib - ia;
  });

  return list;
}


  function showEmptyByState(visibleCount){
    const el = document.getElementById("emptyHint");

    if (LAST_LOAD_ERROR){
      el.innerHTML = `Failed to load data. ${escapeHtml(LAST_LOAD_ERROR)}`;
      el.style.display = "block";
      return;
    }
    if (!ALL_PRODUCTS || ALL_PRODUCTS.length === 0){
      el.innerHTML = `No products loaded. Ensure <code>products.json</code> is available at site root.`;
      el.style.display = "block";
      return;
    }
    if (visibleCount === 0){
      const m = currentMarket();
      const q = (document.getElementById("searchInput").value || "").trim();
      if (q){
        el.innerHTML = `No results for <b>${escapeHtml(m)}</b> with current search.`;
      }else{
        el.innerHTML = `No products for <b>${escapeHtml(m)}</b> yet.`;
      }
      el.style.display = "block";
      return;
    }
    el.style.display = "none";
  }

  function hash32(str){
    const s = String(str || "");
    let h = 2166136261;
    for (let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }
  function seededPick(arr, seed, salt){
    if (!arr || arr.length === 0) return "";
    const h = hash32(seed + "|" + salt);
    return arr[h % arr.length];
  }
  function classifyProduct(p){
    const t = String(p?.title || "").toLowerCase();
    const has = (...kw) => kw.some(k => t.includes(k));
    if (has("birthday","anniversary","gift","present","decor","lamp","night light","plaque","acrylic","frame","sign","ornament")) return "gift_decor";
    if (has("tooth","teeth","whitening","mouth","oral","dental","brush","flosser","water flosser")) return "oral_care";
    if (has("boot","boots","shoe","shoes","sneaker","rain boot","rain boots")) return "footwear";
    if (has("mouse","mice","rat","rodent","pest","repellent","trap","cat","dog","pet")) return "pet_pest";
    if (has("hook","hanger","adhesive","mount","bracket","screw","bolt","drill","tool","hardware")) return "hardware";
    if (has("charger","adapter","usb","hdmi","cable","battery","router","camera","monitor","keyboard","mouse","earbuds","headphone","speaker")) return "electronics";
    if (has("cream","serum","lotion","shampoo","soap","skincare","cosmetic","deodorant","razor")) return "personal_care";
    if (has("hoodie","shirt","t-shirt","jacket","sweater","dress","cap","hat","pants","sock")) return "apparel";
    if (has("kitchen","pan","pot","knife","cook","coffee","mug","bottle","cup","spoon","fork")) return "kitchen";
    if (has("replacement","refill","filter","cartridge","spare")) return "replacement";
    if (has("printer","filament","pla","abs","3d")) return "3d_printing";
    return "general";
  }
  function buildWhyPickedShortAdvisor(p){
    const asin = String(p?.asin || "").trim();
    const market = String(p?.market || "").trim().toUpperCase();
    const seed = (market || "US") + "|" + (asin || "x");
    const bucket = classifyProduct(p);

    const HEADS = ["Why we picked it", "Advisor note", "Quick guidance", "Selection note"];
    const OPENERS = [
      "Picked for a practical fit rather than hype.",
      "Selected as a sensible baseline option.",
      "Chosen for straightforward use and clear selection steps.",
      "Included for common scenarios where details matter."
    ];
    const CHECKS_BY_BUCKET = {
      electronics: [
        "Check: ports/specs match your device (power, size, standards).",
        "Check: compatibility notes and required cables/adapters.",
        "Check: voltage/power requirements and included accessories."
      ],
      footwear: [
        "Check: size chart and fit notes; returns matter for sizing.",
        "Check: material and intended weather/use conditions.",
        "Check: measurements and care instructions before checkout."
      ],
      gift_decor: [
        "Check: dimensions, display method, and personalization details.",
        "Check: what’s included for setup (stand/hardware/parts).",
        "Check: wording/custom options and return policy for customized items."
      ],
      oral_care: [
        "Check: directions, cautions, and included accessories.",
        "Check: replacement parts availability and cleaning guidance.",
        "Check: usage fit for your routine and any sensitivity notes."
      ],
      pet_pest: [
        "Check: placement guidance and safety notes for pets/children.",
        "Check: coverage area and power/operating mode details.",
        "Check: realistic expectations and correct use instructions."
      ],
      hardware: [
        "Check: dimensions, surface compatibility, and load guidance.",
        "Check: install method (adhesive/screws) and required tools.",
        "Check: spacing/clearance and what’s included."
      ],
      kitchen: [
        "Check: dimensions/capacity and material care instructions.",
        "Check: compatibility with your cookware/appliance setup.",
        "Check: what’s included and cleaning guidance."
      ],
      replacement: [
        "Check: exact model/fit compatibility and pack quantity.",
        "Check: specs/dimensions and replacement interval if listed.",
        "Check: variant selection at checkout (model/version)."
      ],
      personal_care: [
        "Check: label directions, cautions, and intended use.",
        "Check: ingredients/notes and personal restrictions.",
        "Check: quantity/size and storage guidance."
      ],
      apparel: [
        "Check: sizing details, fabric, and care instructions.",
        "Check: variant selection (size/color) and return policy.",
        "Check: measurements and fit notes before checkout."
      ],
      general: [
        "Check: size/variant selection and what’s included.",
        "Check: seller/fulfillment and return policy details on Amazon.",
        "Check: key specs and the exact variant at checkout."
      ],
      "3d_printing": [
        "Check: filament type/diameter and spool compatibility.",
        "Check: recommended temps and storage notes if provided.",
        "Check: printer compatibility and material properties."
      ]
    };
    const FINAL_REMINDERS = [
      "Tip: verify the exact variant on Amazon before checkout.",
      "Tip: confirm seller/fulfillment and return terms on Amazon.",
      "Tip: double-check what’s included and the selected option at checkout."
    ];

    const head = seededPick(HEADS, seed, "h");
    const opener = seededPick(OPENERS, seed, "o");
    const checks = CHECKS_BY_BUCKET[bucket] || CHECKS_BY_BUCKET.general;
    const line1 = seededPick(checks, seed, "c1");
    const line2 = seededPick(FINAL_REMINDERS, seed, "r");
    return { head, opener, line1, line2 };
  }
  function whyHtml(p){
    const w = buildWhyPickedShortAdvisor(p);
    return `
      <div class="why">
        <strong>${escapeHtml(w.head)}</strong><br>
        <span class="subtle">${escapeHtml(w.opener)}</span><br>
        • <span class="subtle">${escapeHtml(w.line1)}</span><br>
        • <span class="subtle">${escapeHtml(w.line2)}</span>
      </div>
    `;
  }

  function renderGrid(){
    const grid = document.getElementById("productGrid");
    const items = getVisibleProducts();
    grid.innerHTML = "";

    items.forEach(p => {
      const asin = String(p.asin || "").trim();
      const imgRaw  = String(p.image_url || "").trim();
      const dst = getDstFromLocation();
    const link = dst || normalizeUrl(p.link);

      const card = document.createElement("div");
      card.className = "card";

      const viewAmazon = link
        ? `<a class="btn cta" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer nofollow sponsored">View on Amazon</a>`
        : `<button class="btn cta" onclick="alert('No valid Amazon link for this item.');">View on Amazon</button>`;

      const imgSrc = initialImageUrl(imgRaw);

      card.innerHTML = `
        <div class="image-wrap">
          <img class="product-image"
               src="${escapeHtml(imgSrc)}"
               data-original="${escapeHtml(normalizeUrl(imgRaw) || "")}"
               data-stage="0"
               alt="${escapeHtml(asin || 'Product')}"
               loading="lazy"
               decoding="async"
               referrerpolicy="no-referrer"
               onerror="onImgError(this)"
               onclick='goToProductPage(${encodeProductForOnclick(p)})' />

          ${whyHtml(p)}

          <div class="actions">
            ${viewAmazon}
            <button class="btn cta secondary" onclick='openContactModal(${encodeProductForOnclick(p)})'>Contact / Copy</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });

    showEmptyByState(items.length);

    if (LAST_LOADED_AT && !LAST_LOAD_ERROR){
      setStatus("Loaded", `${items.length}/${ALL_PRODUCTS.length} visible · ${currentMarket()} · ${LAST_LOADED_AT.toLocaleString()} · ${BUILD_VERSION}`);
    }

    // NEW: 列表渲染完成后，如果是从详情返回，则恢复滚动位置
    restoreListScrollPosIfNeeded();
  }

  function encodeProductForOnclick(p){
    // NOTE: Only minimal additions: keyword/store included so detail title can display them.
    const safe = {
      market: p.market || "",
      asin: p.asin || "",
      title: p.title || "",
      keyword: p.keyword || "",
      store: p.store || "",
      link: p.link || "",
      image_url: p.image_url || ""
    };
    return JSON.stringify(safe)
      .replaceAll("&","\\u0026").replaceAll("<","\\u003c").replaceAll(">","\\u003e");
  }

  function renderProductLoading(route){
    showDetail();
    const box = document.getElementById("detailPage");
    box.innerHTML = `
      <div class="detail-wrap">
        <div class="detail-top">
          <div class="detail-head">
            <p class="detail-title">Loading…</p>
            <p class="detail-sub">Market: <b>${escapeHtml(route.market||"")}</b></p>
          </div>
          <button class="btn secondary" onclick="goHome()">← Back to list</button>
        </div>
        <div class="detail-card">
          <div class="detail-note">
            Loading data from <code>products.json</code> / <code>archive.json</code>…
          </div>
        </div>
      </div>
    `;
    document.title = "Loading… • Product Picks";
  }

  function renderNotFound(route){
    showDetail();
    const box = document.getElementById("detailPage");
    box.innerHTML = `
      <div class="detail-wrap">
        <div class="detail-top">
          <div class="detail-head">
            <p class="detail-title">Product not found</p>
            <p class="detail-sub">Market: <b>${escapeHtml(route.market||"")}</b></p>
          </div>
          <button class="btn secondary" onclick="goHome()">← Back to list</button>
        </div>

        <div class="detail-card">
          <div class="detail-note">
            This product reference may have been removed or moved. Please return to the list and search again.
          </div>
        </div>
      </div>
    `;
    document.title = "Product not found • Product Picks";
  }

  function renderDetail(p, marketRaw, keyRaw, isArchived=false){
    showDetail();

    const market = normalizeMarket(marketRaw);
    const asinKey = String(keyRaw || "").trim();
    const asinBase = splitAsinKey(asinKey).base;
    const dst = getDstFromLocation();
    const link = dst || normalizeUrl(p.link);
    const imgRaw = String(p.image_url || "").trim();
    const imgSrc = initialImageUrl(imgRaw);
    const pageLink = buildProductPermalink(market.toLowerCase(), asinKey);

    document.title = `${market} ${asinKey} • Product Reference`;

    const viewAmazon = link
      ? `<a class="btn cta" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer nofollow sponsored">View on Amazon</a>`
      : `<button class="btn cta" onclick="alert('No valid Amazon link for this item.');">View on Amazon</button>`;

    // NOTE: Only change requested by you (display keyword/store in title area).
    const keywordText = String(p.keyword || "").trim();
    const storeText = String(p.store || "").trim();

    const box = document.getElementById("detailPage");
    box.innerHTML = `
      <div class="detail-wrap">
        <div class="detail-top">
          <div class="detail-head">
            <p class="detail-title">Product Reference</p>
            <p class="detail-sub">
              Market: <b>${escapeHtml(market)}</b> · ASIN: <b>${escapeHtml(asinBase)}</b>
              · Keyword: <b>${escapeHtml(keywordText || "—")}</b>
              · Store: <b>${escapeHtml(storeText || "—")}</b>
              ${isArchived ? ' · <span style="color:#b45309;font-weight:800;">Archived</span>' : ''}
            </p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn secondary" onclick="goHome()">← Back</button>
            <button class="btn secondary" onclick="copyText('${escapeHtml(pageLink)}').then(()=>alert('Copied page link!')).catch(()=>alert('Copy failed'))">Copy page link</button>
            <button class="btn secondary" onclick='openContactModal(${encodeProductForOnclick(p)})'>Contact / Copy</button>
          </div>
        </div>

        <div class="detail-card">
          <img class="detail-image"
            src="${escapeHtml(imgSrc)}"
            data-original="${escapeHtml(normalizeUrl(imgRaw) || "")}"
            data-stage="0"
            alt="${escapeHtml(asinKey || 'Product')}"
            loading="lazy"
            decoding="async"
            referrerpolicy="no-referrer"
            onerror="onImgError(this)"
          />

          <div style="display:flex;justify-content:center;margin-top:10px;">
            ${whyHtml(p)}
          </div>

          <div class="detail-actions">
            ${viewAmazon}
            <button class="btn cta secondary" onclick='openContactModal(${encodeProductForOnclick(p)})'>Contact / Copy</button>
          </div>

          <div class="detail-note">
            <strong>Disclosure:</strong> As an Amazon Associate, we earn from qualifying purchases.
            This is an independent site and is not endorsed by Amazon. Purchases are completed on Amazon via the product page.
          </div>
        </div>
      </div>
    `;

    // Make product image clickable (same behavior as "View on Amazon")
    try{
      const imgEl = box.querySelector(".detail-image");
      if (imgEl){
        if (link){
          imgEl.style.cursor = "pointer";
          imgEl.setAttribute("role", "link");
          imgEl.setAttribute("tabindex", "0");
          const openAmazon = (e) => {
            // user gesture → allowed popup
            window.open(link, "_blank", "noopener,noreferrer");
          };
          imgEl.onclick = openAmazon;
          imgEl.onkeydown = (e) => {
            if (e.key === "Enter" || e.key === " "){
              e.preventDefault();
              openAmazon(e);
            }
          };
        }else{
          imgEl.style.cursor = "default";
          imgEl.removeAttribute("role");
          imgEl.removeAttribute("tabindex");
          imgEl.onclick = null;
          imgEl.onkeydown = null;
        }
      }
    }catch(_e){}
  }

  function renderByRoute(){
    const route = parseRoute();

    if (route.type === "product"){
      if ((IS_LOADING || !LAST_LOADED_AT) && !LAST_LOAD_ERROR){
        renderProductLoading(route);
        return;
      }

      let prod = findProductByRoute(ALL_PRODUCTS, route.market, route.key);
      if (prod){
        renderDetail(prod, route.market, route.key, false);
        return;
      }

      prod = findProductByRoute(ARCHIVE_PRODUCTS, route.market, route.key);
      if (prod){
        renderDetail(prod, route.market, route.key, true);
        return;
      }

      renderNotFound(route);
      return;
    }

    showList();
    renderGrid();
  }

  function copyText(text){
    if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
    return new Promise((resolve, reject) => {
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        resolve();
      }catch(e){ reject(e); }
    });
  }

  function buildCopyInfo(product){
    const market = String(product.market || "").trim().toUpperCase();
    const asin = String(product.asin || "").trim();
    const lines = [];
    if (asin) lines.push(`ASIN: ${asin}`);
    if (market) lines.push(`Market: ${market}`);
    return lines.join("\n");
  }

  function buildContactText(product){
    const base = buildCopyInfo(product);
    const lines = [];
    if (base) lines.push(base);
    lines.push("");
    lines.push("Hi, I have a question about this product. Could you please help?");
    return lines.join("\n");
  }

  function openContactModal(product){
    CURRENT_CONTACT_PRODUCT = product;

    const previewText = buildCopyInfo(product);
    document.getElementById("contactPreview").textContent = previewText;

    const contactText = buildContactText(product);

    const waUrl = "https://wa.me/" + WA_PHONE + "?text=" + encodeURIComponent(contactText);
    const tgUrl = "https://t.me/" + TG_USERNAME;

    const subject = `Product question: ${(product.asin||"").trim()} [${(product.market||"").toUpperCase()}]`;
    const mailUrl = "mailto:" + encodeURIComponent(EMAIL_CONTACT)
      + "?subject=" + encodeURIComponent(subject)
      + "&body=" + encodeURIComponent(contactText);

    const waBtn = document.getElementById("contactWA");
    waBtn.href = waUrl;
    waBtn.onclick = (e) => { e.preventDefault(); window.open(waUrl, "_blank", "noopener,noreferrer"); };

    const tgBtn = document.getElementById("contactTG");
    tgBtn.href = tgUrl;
    tgBtn.onclick = (e) => {
      e.preventDefault();
      copyText(contactText)
        .then(() => window.open(tgUrl, "_blank", "noopener,noreferrer"))
        .catch(() => window.open(tgUrl, "_blank", "noopener,noreferrer"));
    };

    const mailBtn = document.getElementById("contactMail");
    mailBtn.href = mailUrl;
    mailBtn.onclick = (e) => { e.preventDefault(); window.open(mailUrl, "_blank", "noopener,noreferrer"); };

    document.getElementById("contactModal").style.display = "block";
  }

  function closeContactModal(){
    document.getElementById("contactModal").style.display = "none";
    CURRENT_CONTACT_PRODUCT = null;
  }

  function copyContactInfo(){
    const text = document.getElementById("contactPreview").textContent || "";
    if (!text) return;
    copyText(text).then(() => alert("Copied!")).catch(() => alert("Copy failed"));
  }

  function mapCountryCodeToMarket(cc){
    const c = String(cc||"").trim().toUpperCase();
    if (!c) return "";
    if (c === "US") return "US";
    if (c === "CA") return "CA";
    if (c === "JP") return "JP";
    if (c === "GB" || c === "UK") return "UK";
    if (c === "DE") return "DE";
    if (c === "FR") return "FR";
    if (c === "IT") return "IT";
    if (c === "ES") return "ES";
    return "";
  }

  async function fetchJsonTimeout(url, ms){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    } finally {
      clearTimeout(t);
    }
  }

  async function resolveMarketByIP(){
    const endpoints = [
      async () => {
        const j = await fetchJsonTimeout("https://ipapi.co/json/", 2500);
        return mapCountryCodeToMarket(j && (j.country_code || j.country));
      },
      async () => {
        const j = await fetchJsonTimeout("https://ipwho.is/", 2500);
        return mapCountryCodeToMarket(j && j.country_code);
      },
      async () => {
        const j = await fetchJsonTimeout("https://ip-api.com/json/?fields=countryCode", 2500);
        return mapCountryCodeToMarket(j && j.countryCode);
      },
    ];

    for (const fn of endpoints){
      try{
        const mk = await fn();
        if (mk && ALLOWED_MARKETS.includes(mk)) return mk;
        if (mk === "") return "";
      }catch(e){}
    }
    return "";
  }

  async function applyDefaultMarketByIP(){
    if (!ENABLE_GEO_IP_AUTO_MARKET) return;

    const route = parseRoute();
    if (route.type !== "list") return;

    const saved = (localStorage.getItem("selectedCountry") || "").toUpperCase();
    const savedOk = ALLOWED_MARKETS.includes(saved) ? saved : "";

    const ipMarket = await resolveMarketByIP();

    if (ipMarket && ALLOWED_MARKETS.includes(ipMarket)){
      document.getElementById("countrySelect").value = ipMarket;
      localStorage.setItem("selectedCountry", ipMarket);
      renderGrid();
      return;
    }

    const fallback = savedOk || "US";
    document.getElementById("countrySelect").value = fallback;
    if (!savedOk) localStorage.setItem("selectedCountry", fallback);
    renderGrid();
  }

  // NEW: 浏览器返回（popstate）时，如果回到列表，渲染后会自动 restoreListScrollPosIfNeeded()
  window.addEventListener("popstate", () => renderByRoute());

  window.onload = function(){
    const saved = localStorage.getItem("selectedCountry");
    if (saved) document.getElementById("countrySelect").value = saved;

    renderByRoute();

    applyDefaultMarketByIP();

    fetchAllData(false);
    setInterval(() => fetchAllData(false), AUTO_REFRESH_MS);
  };
</script>
</body>
</html>
