<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product List</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; color:#111827; }
    header { background:#111827; color:#fff; text-align:center; padding:20px 0; border-bottom:5px solid #fff; }
    header h1 { font-size:2em; font-weight:bold; margin:0 0 10px 0; }
    .country-select{ margin:10px; font-size:1.05em; padding:6px 10px; background:#fff; color:#111827; border:1px solid #ddd; border-radius:6px; outline:none; }
    .contact-text{ font-size:1.05em; margin-top:10px; color:#fff; line-height:1.5; }
    .contact-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; padding:0 12px; }
    .contact-btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; background:#fff; color:#111827; text-decoration:none; border:1px solid rgba(255,255,255,.35); font-weight:600; font-size:14px; }
    .contact-btn:hover{ opacity:.92; }
    section#product-list{ max-width:1200px; margin:18px auto 30px; padding:0 12px; }
    section#product-list h2{ margin:0 0 10px 0; font-size:20px; }
    .status-bar{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; padding:10px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:10px; }
    .status-left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{ padding:4px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px; color:#374151; }
    .muted{ color:#6b7280; font-size:12px; }
    .hint-sub{ font-size:12px; color:#6b7280; margin-left:8px; }
    .filter-wrap{ display:flex; align-items:center; gap:8px; }
    .filter-label{ font-size:12px; color:#374151; font-weight:700; }
    .filter-select{ font-size:12px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:10px; outline:none; background:#fff; color:#111827; }
    .notice-box{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:10px 0; }
    .notice-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .notice-title{ font-weight:800; }
    .notice-body{ margin-top:10px; line-height:1.65; font-size:14px; color:#111827; text-align:left; }
    .notice-body ol{ margin:8px 0 10px 18px; padding:0; }
    .notice-body ul{ margin:8px 0 10px 18px; padding:0; }
    .notice-body li{ margin:6px 0; }
    .notice-muted{ color:#6b7280; font-size:13px; }
    .product-table-container{ width:100%; overflow-x:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
    .product-table{ width:100%; border-collapse:collapse; table-layout:auto; min-width:1040px; }
    .product-table th,.product-table td{ padding:12px; text-align:center; border-bottom:1px solid #eee; vertical-align:middle; font-size:.9em; word-break:break-word; }
    .product-table th{ background:#f4f4f4; position:sticky; top:0; z-index:1; white-space:nowrap; }
    .col-price, .col-commission{ min-width:120px; }
    .sortable{ cursor:pointer; user-select:none; }
    .sort-ind{ display:inline-block; margin-left:6px; font-size:12px; color:#6b7280; }
    .img-cell{ display:flex; justify-content:center; align-items:center; }
    .product-image{ width:120px; height:120px; object-fit:contain; cursor:pointer; border-radius:10px; border:1px solid #e5e7eb; background:#fff; transition: transform .12s ease; }
    .product-image:hover{ transform: scale(1.02); }
    .product-title{ font-weight:bold; font-size:.95em; line-height:1.35; }
    .btn{ padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#111827; color:#fff; cursor:pointer; font-weight:600; font-size:13px; white-space:nowrap; }
    .btn:hover{ opacity:.92; }
    @media (max-width:768px){ header h1{ font-size:1.5em; } .product-table th,.product-table td{ padding:8px; font-size:.8em; } .product-image{ width:96px; height:96px; } .product-title{ font-size:.9em; } .contact-text{ font-size:.95em; } .product-table{ min-width:980px; } .col-price, .col-commission{ min-width:110px; }
    }
    .modal{ display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.7); padding-top:60px; }
    .modal-inner{ width:90%; max-width:560px; margin:0 auto; position:relative; background:#fff; border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
    .close{ position:absolute; top:10px; right:14px; color:#111827; font-size:26px; font-weight:bold; cursor:pointer; user-select:none; line-height:1; }
    .close:hover{ opacity:.7; }
    .empty{ padding:16px 12px; color:#6b7280; font-size:14px; text-align:center; }
    .remark-loading{ font-size:12px; color:#6b7280; margin-top:4px; }
  </style>
</head>

<body>
  <header>
    <h1 id="pageTitle">Product List</h1>

    <select class="country-select" id="countrySelect" onchange="onMarketChange()">
      <option value="UK">UK</option>
      <option value="US">US</option>
      <option value="DE">Germany</option>
      <option value="FR">France</option>
      <option value="IT">Italy</option>
      <option value="ES">Spain</option>
      <option value="CA">Canada</option>
      <option value="JP">Japan</option>
    </select>

    <div class="contact-text" id="contactText">
      For inquiries, you can contact us via WhatsApp, Telegram, or Email:
    </div>

    <div class="contact-actions">
      <a class="contact-btn" href="https://wa.me/8615778673666" target="_blank" rel="noopener">WhatsApp</a>
      <a class="contact-btn" href="https://t.me/dalemyrong" target="_blank" rel="noopener">Telegram</a>
      <a class="contact-btn" href="mailto:info@dalemy.top" target="_blank" rel="noopener">Email</a>
    </div>
  </header>

  <section id="product-list">
    <h2 id="productsTitle">Products</h2>

    <div class="status-bar">
      <div class="status-left">
        <span class="badge" id="statusBadge">Loading…</span>
        <span class="muted" id="statusMeta"></span>
        <span class="hint-sub" id="translateHint"></span>

        <div class="filter-wrap" style="margin-left:8px;">
          <span class="filter-label" id="statusFilterLabel">Status</span>
          <select class="filter-select" id="statusSelect" onchange="onStatusChange()">
            <option value="__all__">All</option>
          </select>
        </div>
      </div>
      <button class="btn" onclick="fetchProductData(true)" id="refreshBtn">Refresh</button>
    </div>

    <div class="notice-box" id="noticeBox">
      <div class="notice-head">
        <div class="notice-title" id="noticeTitle">Important Notice</div>
        <button class="btn" style="background:#374151;" id="noticeToggleBtn" onclick="toggleNotice()">Hide</button>
      </div>
      <div class="notice-body" id="noticeContent"></div>
    </div>

    <div class="product-table-container">
      <table class="product-table">
        <thead>
          <tr>
            <th id="thAction">Action</th>
            <th id="thMarket">Market</th>
            <th id="thImage">Image</th>
            <th id="thTitle">Title</th>
            <th id="thKeyword">Keyword</th>
            <th id="thStore">Store</th>
            <th id="thRemark">Remark</th>

            <th id="thPrice" class="col-price sortable" onclick="toggleSort('price')">
              Discount Price <span class="sort-ind" id="indPrice"></span>
            </th>
            <th id="thCommission" class="col-commission sortable" onclick="toggleSort('commission')">
              Commission <span class="sort-ind" id="indCommission"></span>
            </th>
          </tr>
        </thead>
        <tbody id="product-table-body"></tbody>
      </table>
      <div class="empty" id="emptyHint" style="display:none;">
        No products loaded. If this is your first time, run GitHub Actions once to generate products.json.
      </div>
    </div>
  </section>

  <div id="forwardModal" class="modal" onclick="closeForwardModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
      <span class="close" onclick="closeForwardModal(event)">&times;</span>

      <h3 style="margin:0 0 10px 0;" id="forwardTitle">Forward Product</h3>
      <div style="font-size:13px;color:#6b7280;margin-bottom:8px;" id="forwardSub">
        Choose a channel. A new window will open; this page will stay here.
      </div>

      <div id="forwardPreview"
           style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f9fafb;white-space:pre-wrap;font-size:13px;line-height:1.4;text-align:left;">
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;">
        <button class="btn" style="background:#374151;" onclick="copyForwardText()" id="copyBtn">Copy Text</button>
        <a class="contact-btn" id="forwardWA" href="#" target="_blank" rel="noopener">WhatsApp</a>
        <a class="contact-btn" id="forwardTG" href="#" target="_blank" rel="noopener">Telegram</a>
        <a class="contact-btn" id="forwardMail" href="#" target="_blank" rel="noopener">Email</a>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const PRODUCTS_JSON_PATH = "./products.json";
    const PRODUCT_PAGE_PATH  = "./product.html";

    const WA_PHONE = "8615778673666";
    const TG_USERNAME = "dalemyrong";
    const EMAIL_CONTACT = "info@dalemy.top";

    // ===== State =====
    let ALL_PRODUCTS = [];
    let LAST_LOADED_AT = null;
    let CURRENT_FORWARD_PRODUCT = null;

    let SORT_KEY = null; // null | 'price' | 'commission'
    let STATUS_FILTER = "__all__"; // "__all__" or actual status string

    // ===== Language mapping =====
    const LANG_BY_MARKET = { US:"en", UK:"en", CA:"en", DE:"de", FR:"fr", IT:"it", ES:"es", JP:"ja" };

    // ===== i18n UI =====
    const UI_I18N = window.UI_I18N || {
      en: {
        pageTitle: "Product List",
        productsTitle: "Products",
        contactText: "For inquiries, you can contact us via WhatsApp, Telegram, or Email:",
        refresh: "Refresh",
        translatingHint: "Remark auto-translation is enabled (Chinese only). Original will be kept if translation fails.",
        forwardTitle: "Forward Product",
        forwardSub: "Choose a channel. A new window will open; this page will stay here.",
        copy: "Copy Text",
        statusLabel: "Status",
        th: { action:"Action", market:"Market", image:"Image", title:"Title", keyword:"Keyword", store:"Store", remark:"Remark", price:"Discount Price", commission:"Commission" },
        labels: { market:"Market", price:"Discount Price", commission:"Commission", asin:"ASIN", link:"Link", remark:"Remark" },
        noticeTitle: "Important Notice",
        noticeHide: "Hide",
        noticeShow: "Show",
        all: "All"
      }
    };

    // ===== Status filter =====
    function normalizeStatus(s) {
      const v = String(s ?? "").trim();
      return v ? v : "__empty__";
    }
    function buildStatusOptions(products) {
      const select = document.getElementById("statusSelect");
      const T = tUI();

      const set = new Set();
      for (const p of products) set.add(normalizeStatus(p.status));

      const statuses = Array.from(set)
        .filter(v => v !== "__empty__")
        .sort((a,b) => a.localeCompare(b));

      const keep = STATUS_FILTER || "__all__";
      select.innerHTML = "";

      const optAll = document.createElement("option");
      optAll.value = "__all__";
      optAll.textContent = (T.all || "All");
      select.appendChild(optAll);

      for (const s of statuses) {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
      }

      // restore selection if exists
      const canUseKeep = (keep === "__all__") || statuses.includes(keep);
      select.value = canUseKeep ? keep : "__all__";
      STATUS_FILTER = select.value;
      localStorage.setItem("status_filter", STATUS_FILTER);
    }
    function onStatusChange() {
      const v = document.getElementById("statusSelect").value || "__all__";
      STATUS_FILTER = v;
      localStorage.setItem("status_filter", STATUS_FILTER);
      renderTable();
      translateVisibleRemarks();
    }

    // ===== Forward Modal =====
    async function openForwardModal(product) {
      CURRENT_FORWARD_PRODUCT = product;

      const market = (product.market || "").trim().toUpperCase();
      const lang = LANG_BY_MARKET[market] || "en";
      const T = UI_I18N[lang] || UI_I18N.en;

      const remarkOrig = String(product.remark || "").trim();
      let remarkDisplay = remarkOrig;
      if (remarkOrig && hasChinese(remarkOrig) && lang !== "en") {
        const out = await translateRemark(remarkOrig, lang);
        remarkDisplay = (!out || isBadTranslation(out)) ? remarkOrig : out;
      }

      // Build the message format you requested
      let text = `${product.title || "No Title"}`;  // Default to "No Title" if product title is missing
      text += `\nKeyword: ${product.keyword || "No Keyword"}`;
      text += `\nStore: ${product.store || "No Store"}`;
      text += `\nRemark: ${product.remark || "No Remark"}`;
      text += `\nLink: ${product.link || "No Link"}`;

      // Add discount price if not zero
      if (product.price && product.price !== 0) {
        text += `\nDiscount Price: ${formatMoneyByMarket(product.price, market)}`;
      }

      // Add commission if not zero
      if (product.commission && product.commission !== 0) {
        text += `\nCommission: ${formatMoneyByMarket(product.commission, market)}`;
      }

      document.getElementById("forwardPreview").textContent = text;

      const waUrl = "https://wa.me/" + WA_PHONE + "?text=" + encodeURIComponent(text);
      const waBtn = document.getElementById("forwardWA");
      waBtn.href = waUrl;
      waBtn.onclick = (e) => { e.preventDefault(); window.open(waUrl, "_blank", "noopener"); };

      const tgUrl = "https://t.me/" + TG_USERNAME;
      const tgBtn = document.getElementById("forwardTG");
      tgBtn.href = tgUrl;
      tgBtn.onclick = (e) => {
        e.preventDefault();
        copyText(text).finally(() => window.open(tgUrl, "_blank", "noopener"));
      };

      const subject = `[${market}] ${product.title || "Product"}`.trim();
      const mailUrl =
        "mailto:" + encodeURIComponent(EMAIL_CONTACT) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(text);

      const mailBtn = document.getElementById("forwardMail");
      mailBtn.href = mailUrl;
      mailBtn.onclick = (e) => { e.preventDefault(); window.open(mailUrl, "_blank", "noopener"); };

      document.getElementById("forwardTitle").textContent = T.forwardTitle;
      document.getElementById("forwardSub").textContent = T.forwardSub;
      document.getElementById("copyBtn").textContent = T.copy;

      document.getElementById("forwardModal").style.display = "block";
    }

    function closeForwardModal(e) {
      document.getElementById("forwardModal").style.display = "none";
      CURRENT_FORWARD_PRODUCT = null;
    }

    function copyForwardText() {
      const text = document.getElementById("forwardPreview").textContent || "";
      if (!text) return;
      copyText(text).then(() => alert("Copied!")).catch(() => alert("Copy failed"));
    }

    // ===== Fetch JSON =====
    function fetchProductData(manual = false) {
      const url = PRODUCTS_JSON_PATH + "?ts=" + Date.now();
      setStatus(manual ? "Refreshing…" : "Loading…", "Fetching products.json");

      fetch(url, { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          return res.json();
        })
        .then(products => {
          if (!Array.isArray(products)) throw new Error("products.json is not an array");

          ALL_PRODUCTS = products.map((p, idx) => ({ ...p, __idx: idx }));
          LAST_LOADED_AT = new Date();

          buildStatusOptions(ALL_PRODUCTS);
          renderTable();
          applyI18n();
          translateVisibleRemarks();

          setStatus("Loaded", `${products.length} items · ${LAST_LOADED_AT.toLocaleString()}`);
          showEmptyHint(products.length === 0);
        })
        .catch(err => {
          console.error("Failed to load products.json:", err);
          setStatus("Load failed", err.message);
          showEmptyHint(true);
          if (manual) alert("Failed to load products.json.\n\n" + err.message);
        });
    }

    window.onload = function () {
      fetchProductData(false);
      setInterval(() => fetchProductData(false), AUTO_REFRESH_MS);
    };
  </script>
</body>
</html>
