<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product List</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; color:#111827; }
    header { background:#111827; color:#fff; text-align:center; padding:20px 0; border-bottom:5px solid #fff; }
    header h1 { font-size:2em; font-weight:bold; margin:0 0 10px 0; }
    .country-select{
      margin:10px; font-size:1.05em; padding:6px 10px; background:#fff; color:#111827;
      border:1px solid #ddd; border-radius:6px; outline:none;
    }
    .contact-text{ font-size:1.05em; margin-top:10px; color:#fff; line-height:1.5; }
    .contact-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; padding:0 12px; }
    .contact-btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px;
      background:#fff; color:#111827; text-decoration:none; border:1px solid rgba(255,255,255,.35);
      font-weight:600; font-size:14px;
    }
    .contact-btn:hover{ opacity:.92; }

    section#product-list{ max-width:1200px; margin:18px auto 30px; padding:0 12px; }
    section#product-list h2{ margin:0 0 10px 0; font-size:20px; }

    .status-bar{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:10px;
    }
    .status-left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{ padding:4px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px; color:#374151; }
    .muted{ color:#6b7280; font-size:12px; }

    .product-table-container{ width:100%; overflow-x:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
    .product-table{ width:100%; border-collapse:collapse; table-layout:auto; min-width:980px; }
    .product-table th,.product-table td{
      padding:12px; text-align:left; border-bottom:1px solid #eee; vertical-align:top;
      font-size:.9em; word-break:break-word;
    }
    .product-table th{ background:#f4f4f4; position:sticky; top:0; z-index:1; }

    .product-image{
      width:60px; height:60px; object-fit:contain; cursor:pointer; border-radius:6px;
      border:1px solid #e5e7eb; background:#fff;
    }
    .product-title{ font-weight:bold; font-size:.95em; line-height:1.35; }
    .product-link{ color:#1a73e8; text-decoration:none; font-weight:600; }
    .product-link:hover{ text-decoration:underline; }

    .btn{
      padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb;
      background:#111827; color:#fff; cursor:pointer; font-weight:600; font-size:13px; white-space:nowrap;
    }
    .btn:hover{ opacity:.92; }

    @media (max-width:768px){
      header h1{ font-size:1.5em; }
      .product-table th,.product-table td{ padding:8px; font-size:.8em; }
      .product-image{ width:50px; height:50px; }
      .product-title{ font-size:.9em; }
      .contact-text{ font-size:.95em; }
      .product-table{ min-width:920px; }
    }

    .modal{
      display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,.7); padding-top:60px;
    }
    .modal-inner{
      width:90%; max-width:900px; margin:0 auto; position:relative; background:#fff; border-radius:14px; padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
    }
    .modal-content{
      display:block; width:100%; height:auto; max-height:78vh; object-fit:contain; border-radius:10px;
    }
    .close{
      position:absolute; top:10px; right:14px; color:#111827; font-size:26px; font-weight:bold;
      cursor:pointer; user-select:none; line-height:1;
    }
    .close:hover{ opacity:.7; }

    .empty{ padding:16px 12px; color:#6b7280; font-size:14px; }
  </style>
</head>

<body>
  <header>
    <h1>Product List</h1>

    <select class="country-select" id="countrySelect" onchange="filterProductsByCountry()">
      <option value="UK">UK</option>
      <option value="US">US</option>
      <option value="DE">Germany</option>
      <option value="FR">France</option>
      <option value="IT">Italy</option>
      <option value="ES">Spain</option>
      <option value="CA">Canada</option>
      <option value="JP">Japan</option>
    </select>

    <div class="contact-text">For inquiries, you can contact us via WhatsApp, Telegram, or Email:</div>

    <div class="contact-actions">
      <a class="contact-btn" href="https://wa.me/8615778673666" target="_blank" rel="noopener">WhatsApp</a>
      <a class="contact-btn" href="https://t.me/dalemyrong" target="_blank" rel="noopener">Telegram</a>
      <a class="contact-btn" href="mailto:info@dalemy.top">Email</a>
    </div>
  </header>

  <section id="product-list">
    <h2>Products</h2>

    <div class="status-bar">
      <div class="status-left">
        <span class="badge" id="statusBadge">Loading…</span>
        <span class="muted" id="statusMeta"></span>
      </div>
      <button class="btn" onclick="fetchProductData(true)">Refresh</button>
    </div>

    <div class="product-table-container">
      <table class="product-table">
        <thead>
          <tr>
            <th>Action</th>
            <th>Market</th>
            <th>Image</th>
            <th>Title</th>
            <th>Keyword</th>
            <th>Store</th>
            <th>Remark</th>
            <th>Discount Price</th>
            <th>Commission</th>
          </tr>
        </thead>
        <tbody id="product-table-body"></tbody>
      </table>
      <div class="empty" id="emptyHint" style="display:none;">
        No products loaded. If this is your first time, run GitHub Actions once to generate products.json.
      </div>
    </div>
  </section>

  <!-- Image Modal -->
  <div id="imgModal" class="modal" onclick="closeImageModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
      <span class="close" onclick="closeImageModal(event)">&times;</span>
      <img class="modal-content" id="modalImg" alt="Product image">
    </div>
  </div>

  <!-- Forward Modal -->
  <div id="forwardModal" class="modal" onclick="closeForwardModal(event)">
    <div class="modal-inner" style="max-width:560px;" onclick="event.stopPropagation()">
      <span class="close" onclick="closeForwardModal(event)">&times;</span>

      <h3 style="margin:0 0 10px 0;">Forward Product</h3>
      <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">
        WhatsApp will open with the message pre-filled. You only need to press Send.
      </div>

      <div id="forwardPreview"
           style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f9fafb;white-space:pre-wrap;font-size:13px;line-height:1.4;">
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;">
        <button class="btn" style="background:#374151;" onclick="copyForwardText()">Copy Text</button>
        <a class="contact-btn" id="forwardWA" href="#" target="_blank" rel="noopener">WhatsApp</a>
        <a class="contact-btn" id="forwardTG" href="#" target="_blank" rel="noopener">Telegram</a>
        <a class="contact-btn" id="forwardMail" href="#">Email</a>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    // 站点: https://dalemy-1.github.io/product-list/
    const PRODUCTS_JSON_PATH = "/product-list/products.json";

    // WhatsApp 接收号码（你提供的）
    const WA_PHONE = "8615778673666";
    const TG_USERNAME = "dalemyrong";
    const EMAIL_CONTACT = "info@dalemy.top";

    // ===== State =====
    let ALL_PRODUCTS = [];
    let LAST_LOADED_AT = null;
    let CURRENT_FORWARD_PRODUCT = null;

    function setStatus(text, meta = "") {
      document.getElementById("statusBadge").textContent = text;
      document.getElementById("statusMeta").textContent = meta;
    }
    function showEmptyHint(show) {
      document.getElementById("emptyHint").style.display = show ? "block" : "none";
    }

    // ===== Currency formatting =====
    const MARKET_CURRENCY = {
      US: "USD",
      UK: "GBP",
      DE: "EUR",
      FR: "EUR",
      IT: "EUR",
      ES: "EUR",
      CA: "CAD",
      JP: "JPY",
    };

    function formatMoneyByMarket(value, market) {
      const currency = MARKET_CURRENCY[market] || "USD";
      const num = Number(String(value || "").replace(/[^\d.-]/g, ""));
      if (!Number.isFinite(num)) return String(value || "");

      // 小数位规则：JPY 通常 0 位；其他货币若为整数则不显示 .00
      const isJPY = currency === "JPY";
      const isInt = Math.abs(num - Math.round(num)) < 1e-9;

      const opts = {
        style: "currency",
        currency,
        minimumFractionDigits: isJPY ? 0 : (isInt ? 0 : 2),
        maximumFractionDigits: isJPY ? 0 : 2,
      };

      // 选个通用 locale，让符号显示出来即可
      return new Intl.NumberFormat("en", opts).format(num);
    }

    // ===== Fetch JSON =====
    function fetchProductData(manual = false) {
      const url = PRODUCTS_JSON_PATH + "?ts=" + Date.now();
      setStatus(manual ? "Refreshing…" : "Loading…", "Fetching products.json");

      fetch(url, { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          return res.json();
        })
        .then(products => {
          if (!Array.isArray(products)) throw new Error("products.json is not an array");

          ALL_PRODUCTS = products;
          LAST_LOADED_AT = new Date();

          displayProducts(ALL_PRODUCTS);
          filterProductsByCountry();

          setStatus("Loaded", `${products.length} items · ${LAST_LOADED_AT.toLocaleString()}`);
          showEmptyHint(products.length === 0);
        })
        .catch(err => {
          console.error("Failed to load products.json:", err);
          setStatus("Load failed", err.message);
          showEmptyHint(true);
          if (manual) alert("Failed to load products.json.\n\n" + err.message);
        });
    }

    // ===== Render =====
    function displayProducts(products) {
      const tbody = document.getElementById("product-table-body");
      tbody.innerHTML = "";

      products.forEach(product => {
        const row = document.createElement("tr");
        row.classList.add("product-row");
        row.setAttribute("data-market", (product.market || "").trim());

        const safeTitle = escapeHtml(product.title || "");
        const safeKeyword = escapeHtml(product.keyword || "");
        const safeStore = escapeHtml(product.store || "");
        const safeRemark = escapeHtml(product.remark || "");
        const link = (product.link || "").trim();
        const img = (product.image_url || "").trim();

        const market = (product.market || "").trim();
        const priceFormatted = formatMoneyByMarket(product.price, market);
        const commissionFormatted = formatMoneyByMarket(product.commission, market);

        row.innerHTML = `
          <td>
            <button class="btn" onclick='openForwardModal(${encodeProductForOnclick(product)})'>Forward</button>
          </td>
          <td>${escapeHtml(market)}</td>
          <td>
            ${img ? `
              <img src="${escapeAttr(img)}" alt="${safeTitle}" class="product-image"
                   onclick="openImageModal('${escapeAttr(img)}')" />
            ` : ""}
            ${link ? `<div style="margin-top:6px;"><a class="product-link" href="${escapeAttr(link)}"
                   target="_blank" rel="noopener">Open</a></div>` : ""}
          </td>
          <td class="product-title">${safeTitle}</td>
          <td style="cursor:pointer;" title="Click to copy"
              onclick="copyToClipboard('${escapeAttr(product.keyword || "")}')">${safeKeyword}</td>
          <td>${safeStore}</td>
          <td>${safeRemark}</td>
          <td>${escapeHtml(priceFormatted)}</td>
          <td>${escapeHtml(commissionFormatted)}</td>
        `;
        tbody.appendChild(row);
      });

      showEmptyHint(products.length === 0);
    }

    function encodeProductForOnclick(product) {
      const safe = {
        market: product.market || "",
        asin: product.asin || "",
        title: product.title || "",
        keyword: product.keyword || "",
        store: product.store || "",
        remark: product.remark || "",
        link: product.link || "",
        image_url: product.image_url || "",
        price: product.price || "",
        commission: product.commission || "",
        status: product.status || ""
      };
      return JSON.stringify(safe)
        .replaceAll("&", "\\u0026")
        .replaceAll("<", "\\u003c")
        .replaceAll(">", "\\u003e");
    }

    // ===== Filter =====
    function filterProductsByCountry() {
      const selectedCountry = document.getElementById("countrySelect").value;
      const rows = document.querySelectorAll(".product-row");

      let visibleCount = 0;
      rows.forEach(row => {
        const market = row.getAttribute("data-market");
        if (market === selectedCountry) {
          row.style.display = "";
          visibleCount++;
        } else {
          row.style.display = "none";
        }
      });

      localStorage.setItem("selectedCountry", selectedCountry);

      if (LAST_LOADED_AT) {
        setStatus("Loaded", `${visibleCount}/${ALL_PRODUCTS.length} visible · ${LAST_LOADED_AT.toLocaleString()}`);
      }
    }

    // ===== Copy keyword =====
    function copyToClipboard(text) {
      if (!text) return;
      copyText(text).then(() => alert("Keyword copied!")).catch(() => alert("Copy failed"));
    }

    function copyText(text) {
      if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
      return new Promise((resolve, reject) => {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          resolve();
        } catch (e) { reject(e); }
      });
    }

    // ===== Image Modal =====
    function openImageModal(imgUrl) {
      document.getElementById("modalImg").src = imgUrl;
      document.getElementById("imgModal").style.display = "block";
    }
    function closeImageModal(e) {
      document.getElementById("imgModal").style.display = "none";
      document.getElementById("modalImg").src = "";
    }

    // ===== Forward Modal =====
    function openForwardModal(product) {
      CURRENT_FORWARD_PRODUCT = product;

      const text = buildForwardText(product);
      document.getElementById("forwardPreview").textContent = text;

      // WhatsApp：phone + text 预填（你要求的“自动粘贴到对话框”能做到的上限）
      // 说明：会打开 WhatsApp 并把 text 放在输入框，用户只需点发送
      const waUrl = "https://wa.me/" + WA_PHONE + "?text=" + encodeURIComponent(text);
      const waBtn = document.getElementById("forwardWA");
      waBtn.href = waUrl;

      // Telegram：share/url 预填 text + url（官方方式）
      // Telegram：直接进入与你的账号私聊，而不是“选择联系人”
// 方式：先复制文案，再打开你的私聊链接
const tgBtn = document.getElementById("forwardTG");
tgBtn.href = "https://t.me/" + TG_USERNAME;
tgBtn.onclick = (e) => {
  e.preventDefault();
  copyText(text)
    .then(() => window.open("https://t.me/" + TG_USERNAME, "_blank"))
    .catch(() => window.open("https://t.me/" + TG_USERNAME, "_blank"));
};


      // Email：mailto 预填
      const subject = `[${product.market || ""}] ${product.title || "Product"}`.trim();
      document.getElementById("forwardMail").href =
        "mailto:" + encodeURIComponent(EMAIL_CONTACT) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(text);

      document.getElementById("forwardModal").style.display = "block";
    }

    function closeForwardModal(e) {
      document.getElementById("forwardModal").style.display = "none";
      CURRENT_FORWARD_PRODUCT = null;
    }

    function buildForwardText(p) {
  const market = (p.market || "").trim().toUpperCase();

  const price = formatMoneyByMarket(p.price, market);
  const commission = formatMoneyByMarket(p.commission, market);

  // 多语言字段名
  const LABELS = {
    EN: { market: "Market", price: "Discount Price", commission: "Commission", asin: "ASIN", link: "Link", remark: "Remark" },
    DE: { market: "Markt",  price: "Rabattpreis",    commission: "Provision",  asin: "ASIN", link: "Link", remark: "Hinweis" },
    FR: { market: "Marché", price: "Prix remisé",    commission: "Commission", asin: "ASIN", link: "Lien", remark: "Remarque" },
    IT: { market: "Mercato",price: "Prezzo scontato",commission: "Commissione",asin: "ASIN", link: "Link", remark: "Nota" },
    ES: { market: "Mercado",price: "Precio con descuento", commission: "Comisión", asin: "ASIN", link: "Enlace", remark: "Nota" },
    JP: { market: "マーケット", price: "割引価格", commission: "コミッション", asin: "ASIN", link: "リンク", remark: "備考" },
  };

  // Market -> 语言
  const LANG_BY_MARKET = {
    US: "EN",
    UK: "EN",
    CA: "EN",
    DE: "DE",
    FR: "FR",
    IT: "IT",
    ES: "ES",
    JP: "JP",
  };

  const langKey = LANG_BY_MARKET[market] || "EN";
  const L = LABELS[langKey];

  // 不同语言的引导语（可选）
  const INTRO = {
    EN: "Product details:",
    DE: "Produktdetails:",
    FR: "Détails du produit :",
    IT: "Dettagli del prodotto:",
    ES: "Detalles del producto:",
    JP: "商品詳細：",
  };

  const lines = [];

  // 标题（原样输出，避免误译）
  if (p.title) lines.push(p.title);

  // 可选：加一句引导语（你如果不想要，就删掉下一行）
  // lines.push(INTRO[langKey]);

  lines.push(`${L.market}: ${market || "-"}`);

  if (p.price) lines.push(`${L.price}: ${price}`);
  if (p.commission) lines.push(`${L.commission}: ${commission}`);
  if (p.asin) lines.push(`${L.asin}: ${p.asin}`);
  if (p.link) lines.push(`${L.link}: ${p.link}`);
  if (p.remark) lines.push(`${L.remark}: ${p.remark}`);

  return lines.join("\n");
}


    function copyForwardText() {
      const text = document.getElementById("forwardPreview").textContent || "";
      if (!text) return;
      copyText(text).then(() => alert("Forward text copied!")).catch(() => alert("Copy failed"));
    }

    // ===== XSS safety =====
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function escapeAttr(str) { return escapeHtml(str); }

    // ===== Init =====
    window.onload = function () {
      const savedCountry = localStorage.getItem("selectedCountry");
      document.getElementById("countrySelect").value = savedCountry || "UK";

      fetchProductData(false);

      // 每 15 分钟刷新显示；数据本体由 GitHub Actions 每 15 分钟生成 products.json
      setInterval(() => fetchProductData(false), 15 * 60 * 1000);
    };
  </script>
</body>
</html>


